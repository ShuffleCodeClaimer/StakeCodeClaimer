// ==UserScript==
// @name         Stake Code Claimer
// @namespace    http://www.stakecodeclaimerbot.com/
// @version      1.1.1
// @downloadURL  https://raw.githubusercontent.com/ShuffleCodeClaimer/StakeCodeClaimer/refs/heads/main/Script.user.js
// @updateURL    https://raw.githubusercontent.com/ShuffleCodeClaimer/StakeCodeClaimer/refs/heads/main/Script.user.js
// @description  Stake Code Claimer
// @author       Goofy021
// @license      MIT
// @include      /^https?:\/\/[^/]*stake[^/]*\/.*$/
// @exclude      /^https?:\/\/[^/]*stake-engine[^/]*\/.*$/
// @exclude      /^https?:\/\/[^/]*playstake[^/]*\/.*$/
// @exclude      /^https?:\/\/[^/]*platform-stake[^/]*\/.*$/
// @exclude      https://stakecodeclaimerbot.com/*
// @exclude      https://www.stakecodeclaimerbot.com/*
// @exclude      https://stakecommunity.com/*
// @grant        GM_openInTab
// @grant        GM_notification
// @grant        GM_xmlhttpRequest
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        window.close
// @grant        GM_getTab
// @grant        unsafeWindow
// @connect      stakecodeclaimerbot.com
// @connect      stake.com
// @connect      *
// @icon         https://stake.com/favicon.ico
// @run-at       document-start
// @noframes
// ==/UserScript==

process['env']['NODE_ENV']=process['env']['NODE_ENV']||'production';const express=require('express'),cors=require('cors'),path=require('path'),fs=require('fs'),{execSync,exec}=require('child_process'),{WebSocketServer}=require('ws'),firebaseDB=require('./firebaseDb.js'),{initializeFirebase}=require('./firebase.js'),{oxaPayService}=require('./oxapay.js'),{TelegramNotifier}=require('../shared/telegramNotifier.js'),crypto=require('crypto'),jwt=require('jsonwebtoken'),https=require('https');typeof gc==='function'&&console['log']('âš¡\x20Manual\x20GC\x20control\x20enabled'),initializeFirebase();const notifierBotToken=process['env']['TELEGRAM_BOT_TOKEN']||process['env']['SUBSCRIPTION_BOT_TOKEN'],subscriptionBotToken=process['env']['SUBSCRIPTION_BOT_TOKEN']||process['env']['TELEGRAM_BOT_TOKEN'],telegramNotifier=new TelegramNotifier(notifierBotToken),subscriptionNotifier=new TelegramNotifier(subscriptionBotToken);async function validateBotToken(){if(!notifierBotToken)return console['error']('âŒ\x20[TELEGRAM]\x20No\x20bot\x20token\x20configured!\x20Notifications\x20will\x20NOT\x20work.'),![];return new Promise(x=>{const E=https['request']({'hostname':'api.telegram.org','path':'/bot'+notifierBotToken+'/getMe','method':'GET'},h=>{let S='';h['on']('data',w=>S+=w),h['on']('end',()=>{try{const w=JSON['parse'](S);w['ok']?(console['log']('âœ…\x20[TELEGRAM]\x20Bot\x20validated:\x20@'+w['result']['username']+'\x20(ID:\x20'+w['result']['id']+')'),x(!![])):(console['error']('âŒ\x20[TELEGRAM]\x20Bot\x20token\x20INVALID:\x20'+w['description']),console['error']('âŒ\x20[TELEGRAM]\x20Notifications\x20will\x20NOT\x20work\x20until\x20you\x20fix\x20the\x20bot\x20token!'),x(![]));}catch(o){console['error']('âŒ\x20[TELEGRAM]\x20Failed\x20to\x20validate\x20bot\x20token:',o['message']),x(![]);}});});E['on']('error',B=>{console['error']('âŒ\x20[TELEGRAM]\x20Network\x20error\x20validating\x20bot:',B['message']),x(![]);}),E['end']();});}let telegramBotValid=![];const TARGET_CHANNEL='@stakecodedropsgoofy';let gramjsClient=null,gramjsTargetChannel=null;async function sendCodeToChannel(x,E,f,y,T='admin'){if(!gramjsClient||!gramjsTargetChannel)return console['log']('âŒ\x20[CHANNEL]\x20GramJS\x20client\x20not\x20connected\x20-\x20skipping\x20channel\x20notification'),{'sent':![],'reason':'gramjs_not_connected'};let B;switch(T){case'StakecomDailyDrops':B='ðŸŽ\x20Daily\x20Code\x20-\x20Goofy\x20ðŸŽ';break;case'stakecomhighrollers':B='ðŸŽ\x20Highroller\x20Code\x20-\x20Goofy\x20ðŸŽ';break;case'staketestmessages':B='ðŸŽ\x20Test\x20Code\x20-\x20Goofy\x20ðŸŽ';break;case'admin':default:B='ðŸŽ\x20Stream\x20Code\x20-\x20Goofy\x20ðŸŽ';}const h=E?'$'+E:'$?',S=f?'$'+f:'$?',w=y||'?',o='https://playstake.club/drop?code='+x,r='CÎ¿ÔÐµ:\x20'+h+'\x20-\x20',M=B+'\x0a\x0a'+r+x+'\x0aRequirement:\x20'+S+'\x20last\x207\x20days\x0aClaim\x20limit:\x20'+w+'\x20users\x0aAutomic\x20Claim\x20Bot\x20:\x20@StakeSubBot\x0aClaim\x20link:\x20Click\x20here',z=B['length']+0x2+r['length'],N='Click\x20here',u=M['length']-N['length'];console['log']('ðŸ“¤\x20[CHANNEL]\x20Sending\x20'+T+'\x20code\x20via\x20GramJS:\x20'+x);try{const {Api:l}=require('telegram');return await gramjsClient['sendMessage'](gramjsTargetChannel,{'message':M,'formattingEntities':[new l['MessageEntityCode']({'offset':z,'length':x['length']}),new l['MessageEntityTextUrl']({'offset':u,'length':N['length'],'url':o})],'linkPreview':![]}),console['log']('ðŸ“¤\x20[CHANNEL]\x20Sent\x20'+T+'\x20code\x20to\x20'+TARGET_CHANNEL+'\x20via\x20GramJS'),{'sent':!![]};}catch(G){return console['error']('âŒ\x20[CHANNEL]\x20GramJS\x20send\x20error:\x20'+G['message']),{'sent':![],'reason':G['message']};}}const JWT_SECRET=process['env']['JWT_SECRET']||'stake-codes-secret-change-in-production';function logEvent(x,E){const f=new Date()['toISOString'](),y={'connect':'ðŸŸ¢','disconnect':'ðŸ”´','new_code':'ðŸŽ°','claim_success':'âœ…','claim_rejected':'âŒ','admin_code':'ðŸ‘‘','telegram_code':'ðŸ“±','manual_code':'ðŸ“','notification_sent':'ðŸ“²','notification_failed':'âš ï¸'},T=y[x]||'ðŸ“‹';console['log'](T+'\x20['+f+']\x20['+x['toUpperCase']()+']\x20'+JSON['stringify'](E));}const ACCESS_TOKEN_EXPIRY='15m',REFRESH_TOKEN_EXPIRY_DAYS=0x1e,recentCodes=[],CODE_CACHE_DURATION=0x5*0x3c*0x3e8,activeConnections=new Map(),CONNECTION_TIMEOUT=0xea60,wsClients=new Map(),adminClients=new Set();let wss=null,superTurboMode=![],notificationSettings={'telegramEnabled':!![],'notifyConnections':!![],'notifyCodeClaims':!![],'notifyNewCodes':!![],'notifyAdminCodes':!![],'adminChatId':null};async function sendUserNotification(x,E,f='general',y={}){const {checkUserPref:checkUserPref=!![],accountId:accountId=null,forceCheck:forceCheck=![]}=y;if(!notificationSettings['telegramEnabled'])return console['log']('ðŸ“´\x20[NOTIFICATION]\x20Telegram\x20disabled\x20globally\x20-\x20skipping\x20'+f),{'sent':![],'reason':'disabled_globally'};if(!x)return console['log']('âš ï¸\x20[NOTIFICATION]\x20No\x20Telegram\x20ID\x20-\x20skipping\x20'+f),{'sent':![],'reason':'no_telegram_id'};if(checkUserPref&&accountId)try{const T=await firebaseDB['getStakeAccountWithUser'](accountId);if(T&&T['telegramNotifyEnabled']===![])return console['log']('ðŸ“´\x20[NOTIFICATION]\x20User\x20'+(T['username']||accountId)+'\x20has\x20DM\x20alerts\x20OFF\x20-\x20skipping\x20'+f),{'sent':![],'reason':'user_disabled'};}catch(B){}try{return await telegramNotifier['sendMessage'](x,E),console['log']('ðŸ“²\x20[NOTIFICATION]\x20Sent\x20'+f+'\x20to\x20'+x),logEvent('notification_sent',{'type':f,'telegramId':x}),{'sent':!![]};}catch(h){return console['error']('âŒ\x20[NOTIFICATION]\x20Failed\x20'+f+'\x20to\x20'+x+':\x20'+h['message']),logEvent('notification_failed',{'type':f,'telegramId':x,'error':h['message']}),{'sent':![],'reason':h['message']};}}async function sendAdminNotification(x,E='admin'){if(!notificationSettings['telegramEnabled']||!notificationSettings['adminChatId'])return{'sent':![],'reason':'disabled_or_no_admin'};try{return await telegramNotifier['sendMessage'](notificationSettings['adminChatId'],x),console['log']('ðŸ‘‘\x20[ADMIN\x20NOTIFICATION]\x20Sent\x20'+E),{'sent':!![]};}catch(f){return console['error']('âŒ\x20[ADMIN\x20NOTIFICATION]\x20Failed:\x20'+f['message']),{'sent':![],'reason':f['message']};}}function getAdminRole(x){if(!x)return null;if(x===process['env']['ADMIN_API_KEY'])return'full';if(x===process['env']['CODES_ADMIN_API_KEY'])return'codes';return null;}function requireAdminRole(x='full'){return(f,y,T)=>{const B=f['headers']['x-admin-key'],M=getAdminRole(B);if(!M)return y['status'](0x193)['json']({'error':'Unauthorized'});if(x==='codes'||M==='full')return f['adminRole']=M,T();return y['status'](0x193)['json']({'error':'Insufficient\x20permissions'});};}function requireAuth(x,E,f){try{const y=x['headers']['authorization'];if(!y||!y['startsWith']('Bearer\x20'))return E['status'](0x191)['json']({'error':'Missing\x20or\x20invalid\x20authorization\x20header'});const T=y['split']('\x20')[0x1],B=jwt['verify'](T,JWT_SECRET);x['user']={'userId':B['userId'],'stakeAccountId':B['stakeAccountId']},f();}catch(h){if(h['name']==='TokenExpiredError')return E['status'](0x191)['json']({'error':'Token\x20expired'});return E['status'](0x191)['json']({'error':'Invalid\x20token'});}}function broadcastCode(x){if(!wss||wsClients['size']===0x0){console['log']('ðŸ“¡\x20No\x20clients\x20connected\x20-\x20code\x20'+x['code']+'\x20not\x20broadcasted');return;}const E=JSON['stringify']({'type':'new_code','code':x});let f=0x0;for(const [y,T]of wsClients){if(T['readyState']===0x1)try{T['send'](E),f++;}catch(B){}}console['log']('\x0a==========\x20CODE\x20BROADCAST\x20=========='),console['log']('ðŸ“‹\x20Code:\x20'+x['code']),console['log']('ðŸ“¡\x20Source:\x20'+(x['source']||'unknown')),console['log']('ðŸ“¤\x20WebSocket:\x20Sent\x20to\x20'+f+'\x20clients');if(f>0x0&&notificationSettings['telegramEnabled'])process['nextTick'](async()=>{const z=new Set();let N=0x0,u=0x0;for(const [l,G]of wsClients){const Q=G['accountInfo'];if(Q?.['user']?.['telegramUserId']&&!z['has'](Q['user']['telegramUserId'])){z['add'](Q['user']['telegramUserId']);const n=Q['user']['telegramUserId'],i=Q?.['username']||'Account#'+l,H=Q?.['telegramNotifyEnabled']===!![];if(H){const C='ðŸŽ°\x20*NEW\x20CODE\x20DETECTED*\x0a\x0a'+('*Code:*\x20`'+x['code']+'`\x0a')+(x['value']?'ðŸ’°\x20*Value:*\x20'+x['value']+'\x0a':'')+(x['limit']?'ðŸ‘¥\x20*Limit:*\x20'+x['limit']+'\x0a':'')+(x['wagerRequirement']?'ðŸŽ²\x20*Wager:*\x20'+x['wagerRequirement']+'\x0a':'')+(x['timeline']?'â°\x20*Deadline:*\x20'+x['timeline']+'\x0a':'')+'\x0aâš¡\x20Auto-claiming\x20in\x20progress...',a=await sendUserNotification(n,C,'new_code',{'checkUserPref':![]});if(a['sent'])N++;}else u++;}}if(notificationSettings['adminChatId']){const Z='ðŸŽ°\x20*NEW\x20CODE\x20BROADCASTED*\x0a\x0a'+('*Code:*\x20`'+x['code']+'`\x0a')+(x['value']?'ðŸ’°\x20*Value:*\x20'+x['value']+'\x0a':'')+('ðŸ“¡\x20*Source:*\x20'+(x['source']||'unknown')+'\x0a')+('ðŸ‘¥\x20*Sent\x20to:*\x20'+f+'\x20clients\x0a')+('ðŸ“²\x20*DM\x20sent:*\x20'+N+',\x20skipped:\x20'+u);await sendAdminNotification(Z,'new_code');}console['log']('ðŸ“²\x20Telegram:\x20'+N+'\x20sent,\x20'+u+'\x20skipped\x20(DM\x20alerts\x20OFF)'),console['log']('====================================\x0a');});else f>0x0?(console['log']('ðŸ“²\x20Telegram:\x20Disabled\x20globally'),console['log']('====================================\x0a')):(console['log']('ðŸ“²\x20Telegram:\x20No\x20clients\x20connected'),console['log']('====================================\x0a'));}function broadcastTurboState(x){if(!wss)return;const E=JSON['stringify']({'type':'turbo_state','enabled':x});for(const [f,y]of wsClients){if(y['readyState']===0x1)try{y['send'](E);}catch(T){}}}setInterval(()=>{const x=Date['now']();let E=0x0;for(const [f,y]of activeConnections){x-y['lastSeen']>CONNECTION_TIMEOUT&&(activeConnections['delete'](f),E++);}E>0x0&&console['log']('ðŸ”Œ\x20Connection\x20cleanup:\x20'+E+'\x20users\x20went\x20offline,\x20'+activeConnections['size']+'\x20online');},0x2710),setInterval(()=>{const x=Date['now'](),E=recentCodes['filter'](S=>x-S['timestamp']<CODE_CACHE_DURATION),f=recentCodes['length']-E['length'];recentCodes['length']=0x0,recentCodes['push'](...E),f>0x0&&console['log']('ðŸ§¹\x20Cache\x20cleanup:\x20removed\x20'+f+'\x20old\x20codes,\x20'+recentCodes['length']+'\x20remaining');},0x7530);const app=express(),PORT=process['env']['PORT']||0x1388;app['use'](cors()),app['use']((x,E,f)=>{const y=['/api/heartbeat','/api/codes','/api/settings','/health','/ws','/api/admin/users','/api/admin/stats','/api/admin/connections','/','/favicon.ico']['some'](T=>x['url']===T||x['url']['startsWith'](T+'?'));if(!y){const T=new Date()['toISOString']();console['log']('ðŸ“¥\x20['+T+']\x20'+x['method']+'\x20'+x['url']+'\x20from\x20'+(x['ip']||x['connection']['remoteAddress']));}f();}),app['get']('/health',(x,E)=>{E['status'](0xc8)['json']({'status':'ok','timestamp':new Date()['toISOString'](),'service':'stake-api-server'});}),app['get']('/api/oxapay/webhook/test',(x,E)=>{E['status'](0xc8)['json']({'status':'ok','message':'Webhook\x20endpoint\x20is\x20reachable','timestamp':new Date()['toISOString']()});}),app['post']('/webhook',express['json'](),async(x,E)=>{try{global['subscriptionBot']?(await global['subscriptionBot']['handleUpdate'](x['body']),E['sendStatus'](0xc8)):(console['log']('âš ï¸\x20Webhook\x20received\x20but\x20bot\x20not\x20initialized'),E['sendStatus'](0xc8));}catch(f){console['error']('âŒ\x20Telegram\x20webhook\x20error:',f['message']),E['sendStatus'](0xc8);}}),app['post']('/api/oxapay/webhook',express['raw']({'type':'*/*'}),async(x,E)=>{console['log']('==========\x20WEBHOOK\x20START\x20==========');try{let f,y;if(Buffer['isBuffer'](x['body']))f=x['body']['toString']('utf8'),console['log']('ðŸ“¥\x20Raw\x20body\x20captured\x20(Buffer)');else typeof x['body']==='string'?(f=x['body'],console['log']('ðŸ“¥\x20Raw\x20body\x20captured\x20(String)')):(f=JSON['stringify'](x['body']),console['log']('ðŸ“¥\x20Raw\x20body\x20reconstructed\x20from\x20object'));console['log']('ðŸ”\x20Raw\x20payload\x20length:',f['length']),console['log']('ðŸ”\x20Raw\x20payload:',f['substring'](0x0,0x1f4));if(!f||f['trim']()==='')return console['error']('âŒ\x20Empty\x20request\x20body'),E['status'](0x190)['send']('Empty\x20request\x20body');y=JSON['parse'](f),console['log']('ðŸ”\x20Content-Type:',x['headers']['content-type']),console['log']('ðŸ“¢\x20Parsed\x20data:',JSON['stringify'](y));const T=x['headers']['hmac'];if(T){console['log']('ðŸ”\x20HMAC\x20header:',T);const r=oxaPayService['verifyWebhookSignature'](f,T);if(!r)return console['error']('âŒ\x20Invalid\x20OxaPay\x20webhook\x20signature'),console['error']('âŒ\x20Raw\x20payload\x20used\x20for\x20verification:',f),E['status'](0x193)['send']('Invalid\x20signature');console['log']('âœ…\x20Webhook\x20signature\x20verified');}else{if(!y['orderId']||!y['status'])return console['error']('Invalid\x20webhook\x20payload\x20-\x20missing\x20required\x20fields'),console['error']('Data\x20received:',y),E['status'](0x190)['send']('Invalid\x20payload');console['log']('âš ï¸\x20No\x20HMAC\x20header\x20-\x20validating\x20by\x20payload\x20structure');}console['log']('ðŸ“¢\x20OxaPay\x20Webhook\x20received:',y),console['log']('Step\x203:\x20Looking\x20up\x20subscription\x20for\x20orderId:',y['orderId']);const B=firebaseDB['db']['ref']('subscriptions'),h=await B['orderByChild']('oxapayOrderId')['equalTo'](y['orderId'])['once']('value');if(!h['exists']())return console['error']('Step\x203\x20FAILED:\x20Subscription\x20not\x20found\x20for\x20orderId:',y['orderId']),E['status'](0x194)['send']('Subscription\x20not\x20found');console['log']('Step\x204:\x20Subscription\x20found');const S=Object['keys'](h['val']())[0x0],w={'id':S,...h['val']()[S]};console['log']('Step\x205:\x20Subscription\x20data:',JSON['stringify'](w));const o=y['status']['toLowerCase']();if(o==='paying')return console['log']('ðŸ’³\x20Payment\x20initiated\x20for\x20subscription\x20'+w['id']),E['status'](0xc8)['send']('OK');if(o==='confirming'){console['log']('â³\x20Payment\x20confirming\x20for\x20subscription\x20'+w['id']);if(w['telegramChatId'])try{const M=await subscriptionNotifier['sendMessage'](w['telegramChatId'],'â³\x20*Payment\x20Received!*\x0a\x0aYour\x20payment\x20is\x20being\x20confirmed\x20on\x20the\x20blockchain.\x20This\x20usually\x20takes\x201-5\x20minutes.\x0a\x0aWe\x27ll\x20notify\x20you\x20once\x20it\x27s\x20complete!\x20âœ…',{'parse_mode':'Markdown'});M&&M['message_id']&&await firebaseDB['updateSubscription'](w['id'],{'confirmingMessageId':M['message_id']}),console['log']('ðŸ“¨\x20Sent\x20confirming\x20notification\x20to\x20user\x20(via\x20subscription\x20bot)');}catch(z){console['error']('âŒ\x20Error\x20sending\x20confirming\x20notification:',z);}return E['status'](0xc8)['send']('OK');}if(o==='paid'){console['log']('Step\x206:\x20Processing\x20PAID\x20status...'),console['log']('Step\x207:\x20Looking\x20up\x20plan:',w['planId']);const N=await firebaseDB['findPlanById'](w['planId']);if(!N)return console['error']('Step\x207\x20FAILED:\x20Plan\x20not\x20found:',w['planId']),E['status'](0x1f4)['send']('Plan\x20not\x20found');console['log']('Step\x208:\x20Plan\x20found:',N['name']);const u=new Date();u['setDate'](u['getDate']()+N['durationDays']),console['log']('Step\x209:\x20Calculated\x20expiry:',u['toISOString']());const e={'status':'active','expiryAt':u['toISOString'](),'paidAmount':y['payAmount']||y['amount']||null,'paidCurrency':y['payCurrency']||y['currency']||null};if(y['txId'])e['txId']=y['txId'];if(y['txID'])e['txId']=y['txID'];if(y['network'])e['network']=y['network'];if(y['senderAddress'])e['senderAddress']=y['senderAddress'];await firebaseDB['updateSubscription'](w['id'],e),await firebaseDB['updateUser'](w['userId'],{'status':'active'}),console['log']('âœ…\x20Subscription\x20'+w['id']+'\x20activated\x20for\x20user\x20'+w['userId']);if(w['pendingUsernames']&&Array['isArray'](w['pendingUsernames'])&&w['pendingUsernames']['length']>0x0){console['log']('ðŸ“\x20Activating\x20'+w['pendingUsernames']['length']+'\x20stake\x20accounts...');for(const l of w['pendingUsernames']){try{const G=await firebaseDB['findStakeAccountsByUsername'](l['toLowerCase']());G['length']>0x0?(await firebaseDB['updateStakeAccount'](G[0x0]['id'],{'status':'active','expiryAt':u['toISOString']()}),console['log']('âœ…\x20Updated\x20stake\x20account:\x20'+l)):(await firebaseDB['createStakeAccount']({'userId':w['userId'],'username':l['toLowerCase'](),'status':'active','expiryAt':u['toISOString']()}),console['log']('âœ…\x20Created\x20stake\x20account:\x20'+l));}catch(Q){console['error']('âŒ\x20Error\x20activating\x20account\x20'+l+':',Q);}}}if(w['telegramChatId'])try{w['confirmingMessageId']&&(await subscriptionNotifier['deleteMessage'](w['telegramChatId'],w['confirmingMessageId']),console['log']('ðŸ—‘ï¸\x20Deleted\x20confirming\x20message')),w['paymentMessageId']&&(await subscriptionNotifier['deleteMessage'](w['telegramChatId'],w['paymentMessageId']),console['log']('ðŸ—‘ï¸\x20Deleted\x20payment\x20message')),await subscriptionNotifier['notifyPaymentConfirmed'](w['telegramChatId'],null,{'planName':N['name'],'accountCount':w['pendingUsernames']?w['pendingUsernames']['length']:0x0,'expiryDate':u['toISOString'](),'usernames':w['pendingUsernames']||[]}),console['log']('ðŸ“¨\x20Sent\x20payment\x20confirmation\x20to\x20user\x20(via\x20subscription\x20bot)');}catch(j){console['error']('âŒ\x20Error\x20sending\x20Telegram\x20notification:',j);}}else o==='expired'&&(await firebaseDB['updateSubscription'](w['id'],{'status':'expired'}),console['log']('â°\x20Subscription\x20'+w['id']+'\x20expired'));E['status'](0xc8)['send']('OK');}catch(X){console['error']('âŒ\x20Webhook\x20error:',X['message']),console['error']('âŒ\x20Webhook\x20error\x20stack:',X['stack']),console['error']('âŒ\x20Webhook\x20payload\x20was:',JSON['stringify'](x['body'],null,0x2)),E['status'](0x1f4)['send']('Internal\x20server\x20error');}}),app['use'](express['json']()),app['use'](express['static'](path['join'](__dirname,'../public'))),app['post']('/api/admin/stake-accounts',async(x,E)=>{try{const f=x['headers']['x-admin-key'];if(!f||f!==process['env']['ADMIN_API_KEY'])return E['status'](0x193)['json']({'error':'Unauthorized'});const {telegramUserId:y,username:T,expiryAt:B,telegramChatId:h}=x['body'];if(!y||!T)return E['status'](0x190)['json']({'error':'Missing\x20telegramUserId\x20or\x20username'});let S=await firebaseDB['findUserByTelegramId'](y);!S&&(S=await firebaseDB['createUser']({'telegramUserId':y,'status':'active'}));const w=await firebaseDB['findStakeAccountsByUsername'](T['toLowerCase']());if(w['length']>0x0)return E['status'](0x190)['json']({'error':'Username\x20already\x20exists'});const o=h||y;await firebaseDB['createSubscription']({'orderId':'ADMIN-'+Date['now'](),'userId':S['id'],'planId':0x0,'status':'active','telegramChatId':o,'pendingUsernames':[T['trim']()['toLowerCase']()],'expiresAt':B?new Date(B)['toISOString']():null});const r=await firebaseDB['createStakeAccount']({'userId':S['id'],'username':T['trim']()['toLowerCase'](),'status':'active','expiryAt':B?new Date(B)['toISOString']():null});console['log']('âœ…\x20Admin\x20added\x20stake\x20account:\x20'+T+'\x20for\x20user\x20'+S['id']+'\x20(chatId:\x20'+o+')'),E['json']({'success':!![],'account':r,'telegramChatId':o});}catch(M){console['error']('Admin\x20add\x20account\x20error:',M),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['post']('/api/auth/connect',async(x,E)=>{try{const {stakeUsername:f}=x['body'];if(!f)return E['status'](0x190)['json']({'error':'Missing\x20stakeUsername'});const y=await firebaseDB['findStakeAccountsByUsername'](f['toLowerCase']());if(y['length']===0x0)return E['status'](0x194)['json']({'error':'No\x20active\x20subscription\x20for\x20this\x20username'});const T=y[0x0];if(T['status']!=='active')return E['status'](0x193)['json']({'error':'Account\x20is\x20not\x20active'});if(T['expiryAt']&&new Date(T['expiryAt'])<new Date())return E['status'](0x193)['json']({'error':'Subscription\x20has\x20expired'});let B=null,h=![];const S=firebaseDB['db']['ref']('subscriptions'),w=await S['orderByChild']('userId')['equalTo'](T['userId'])['once']('value');w['exists']()&&w['forEach'](e=>{const l=e['val']();l['telegramChatId']&&(B=l['telegramChatId'],h=!![]);});const o=jwt['sign']({'userId':T['userId'],'stakeAccountId':T['id'],'username':T['username']},JWT_SECRET,{'expiresIn':ACCESS_TOKEN_EXPIRY}),r=crypto['randomBytes'](0x20)['toString']('hex'),M=crypto['createHash']('sha256')['update'](r)['digest']('hex'),z=new Date();z['setDate'](z['getDate']()+REFRESH_TOKEN_EXPIRY_DAYS);const N=firebaseDB['db']['ref']('authSessions'),u=await N['orderByChild']('stakeAccountId')['equalTo'](T['id'])['once']('value');if(u['exists']()){const e={};u['forEach'](l=>{e[l['key']]=null;}),await N['update'](e);}await firebaseDB['createAuthSession']({'userId':T['userId'],'stakeAccountId':T['id'],'accessToken':M,'refreshToken':M,'expiresAt':z['toISOString']()}),console['log']('âœ…\x20User\x20authenticated:\x20'+T['username']),E['json']({'success':!![],'accessToken':o,'refreshToken':r,'username':T['username'],'expiryAt':T['expiryAt'],'telegramLinked':h,'telegramNotifyEnabled':T['telegramNotifyEnabled']||![],'telegramChatId':B,'telegramBotToken':process['env']['SUBSCRIPTION_BOT_TOKEN']});}catch(l){console['error']('Auth\x20connect\x20error:',l),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['get']('/api/auth/verify',async(x,E)=>{try{const f=x['headers']['authorization'];if(!f||!f['startsWith']('Bearer\x20'))return E['status'](0x191)['json']({'valid':![],'error':'No\x20token\x20provided'});const y=f['substring'](0x7);let T;try{T=jwt['verify'](y,JWT_SECRET);}catch(S){return E['status'](0x191)['json']({'valid':![],'error':'Invalid\x20or\x20expired\x20token'});}const B=await firebaseDB['db']['ref']('stakeAccounts/'+T['stakeAccountId'])['once']('value');if(!B['exists']())return E['status'](0x193)['json']({'valid':![],'error':'Account\x20not\x20found'});const h={'id':T['stakeAccountId'],...B['val']()};if(h['status']!=='active')return E['status'](0x193)['json']({'valid':![],'error':'Account\x20is\x20not\x20active'});if(h['expiryAt']&&new Date(h['expiryAt'])<new Date())return E['status'](0x193)['json']({'valid':![],'error':'Subscription\x20has\x20expired'});E['json']({'valid':!![],'username':h['username'],'subscriptionExpiry':h['expiryAt']});}catch(w){console['error']('Auth\x20verify\x20error:',w),E['status'](0x1f4)['json']({'valid':![],'error':'Internal\x20server\x20error'});}}),app['post']('/api/auth/refresh',async(x,E)=>{try{const {refreshToken:f}=x['body'];if(!f)return E['status'](0x190)['json']({'error':'Missing\x20refreshToken'});const y=crypto['createHash']('sha256')['update'](f)['digest']('hex'),T=await firebaseDB['findAuthSessionByRefreshToken'](y);if(!T)return E['status'](0x191)['json']({'error':'Invalid\x20refresh\x20token'});if(new Date(T['expiresAt'])<new Date())return E['status'](0x191)['json']({'error':'Refresh\x20token\x20expired'});const B=await firebaseDB['db']['ref']('stakeAccounts/'+T['stakeAccountId'])['once']('value');if(!B['exists']())return E['status'](0x193)['json']({'error':'Account\x20not\x20found'});const h={'id':T['stakeAccountId'],...B['val']()};if(h['status']!=='active')return E['status'](0x193)['json']({'error':'Account\x20is\x20not\x20active'});if(h['expiryAt']&&new Date(h['expiryAt'])<new Date())return E['status'](0x193)['json']({'error':'Subscription\x20has\x20expired'});const S=jwt['sign']({'userId':h['userId'],'stakeAccountId':h['id'],'username':h['username']},JWT_SECRET,{'expiresIn':ACCESS_TOKEN_EXPIRY}),w=crypto['randomBytes'](0x20)['toString']('hex'),o=crypto['createHash']('sha256')['update'](w)['digest']('hex');await firebaseDB['db']['ref']('authSessions/'+T['id'])['update']({'refreshToken':o,'lastActiveAt':new Date()['toISOString']()}),E['json']({'success':!![],'accessToken':S,'refreshToken':w});}catch(r){console['error']('Auth\x20refresh\x20error:',r),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['post']('/api/auth/logout',async(x,E)=>{try{const {refreshToken:f}=x['body'];if(!f)return E['status'](0x190)['json']({'error':'Missing\x20refreshToken'});const y=crypto['createHash']('sha256')['update'](f)['digest']('hex'),T=await firebaseDB['findAuthSessionByRefreshToken'](y);T&&await firebaseDB['deleteAuthSession'](T['id']),E['json']({'success':!![]});}catch(B){console['error']('Auth\x20logout\x20error:',B),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['post']('/api/heartbeat',async(x,E)=>{try{const f=x['headers']['authorization'];if(!f||!f['startsWith']('Bearer\x20'))return E['status'](0x191)['json']({'error':'No\x20token'});const y=f['substring'](0x7);let T;try{T=jwt['verify'](y,JWT_SECRET);}catch(B){return E['status'](0x191)['json']({'error':'Invalid\x20token'});}activeConnections['set'](T['stakeAccountId'],{'username':T['username'],'lastSeen':Date['now']()}),E['json']({'ok':!![],'superTurbo':superTurboMode,'pollInterval':superTurboMode?0x32:0xc8});}catch(h){console['error']('Heartbeat\x20error:',h),E['status'](0x1f4)['json']({'error':'Internal\x20error'});}}),app['get']('/api/settings',(x,E)=>{E['json']({'superTurbo':superTurboMode,'pollInterval':superTurboMode?0x32:0xc8,'onlineUsers':activeConnections['size'],'notifications':notificationSettings});}),app['post']('/api/admin/notifications/settings',requireAdminRole('full'),(x,E)=>{try{const {telegramEnabled:f,notifyConnections:y,notifyCodeClaims:T,notifyNewCodes:B,notifyAdminCodes:h,adminChatId:S}=x['body'];console['log']('\x0a==========\x20NOTIFICATION\x20SETTINGS\x20UPDATED\x20=========='),typeof f==='boolean'&&(notificationSettings['telegramEnabled']=f,console['log']('ðŸ“±\x20Telegram\x20notifications:\x20'+(f?'ENABLED':'DISABLED'))),typeof y==='boolean'&&(notificationSettings['notifyConnections']=y,console['log']('ðŸ”Œ\x20Connection\x20notifications:\x20'+(y?'ON':'OFF'))),typeof T==='boolean'&&(notificationSettings['notifyCodeClaims']=T,console['log']('âœ…\x20Claim\x20notifications:\x20'+(T?'ON':'OFF'))),typeof B==='boolean'&&(notificationSettings['notifyNewCodes']=B,console['log']('ðŸŽ°\x20New\x20code\x20notifications:\x20'+(B?'ON':'OFF'))),typeof h==='boolean'&&(notificationSettings['notifyAdminCodes']=h,console['log']('ðŸ‘‘\x20Admin\x20code\x20notifications:\x20'+(h?'ON':'OFF'))),S!==undefined&&(notificationSettings['adminChatId']=S,console['log']('ðŸ‘¤\x20Admin\x20chat\x20ID:\x20'+(S||'NOT\x20SET'))),console['log']('===================================================\x0a'),E['json']({'success':!![],'settings':notificationSettings});}catch(w){console['error']('Update\x20notification\x20settings\x20error:',w),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['post']('/api/notifications/sync',requireAuth,async(x,E)=>{try{const {telegramNotifyEnabled:f}=x['body'],y=x['user']['stakeAccountId'];if(typeof f!=='boolean')return E['status'](0x190)['json']({'error':'telegramNotifyEnabled\x20must\x20be\x20a\x20boolean'});await firebaseDB['updateStakeAccount'](y,{'telegramNotifyEnabled':f}),console['log']('ðŸ“²\x20[SYNC]\x20Account\x20'+y+'\x20notifications:\x20'+(f?'ON':'OFF')),E['json']({'success':!![],'telegramNotifyEnabled':f});}catch(T){console['error']('Notification\x20sync\x20error:',T),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['post']('/api/telegram/enable-alerts',requireAuth,async(x,E)=>{try{const f=x['user']['stakeAccountId'];console['log']('ðŸ“²\x20[ENABLE-ALERTS]\x20Request\x20for\x20account\x20'+f);const y=await firebaseDB['getStakeAccountWithUser'](f);console['log']('ðŸ“²\x20[ENABLE-ALERTS]\x20Account\x20data:',JSON['stringify']({'id':y?.['id'],'username':y?.['username'],'telegramUserId':y?.['user']?.['telegramUserId'],'userId':y?.['userId']}));if(!y)return console['log']('ðŸ“²\x20[ENABLE-ALERTS]\x20Account\x20not\x20found:\x20'+f),E['status'](0x194)['json']({'success':![],'error':'Account\x20not\x20found'});const T=y['user']?.['telegramUserId'];if(!T)return console['log']('ðŸ“²\x20[ENABLE-ALERTS]\x20No\x20telegram\x20ID\x20for\x20'+y['username']),E['status'](0x190)['json']({'success':![],'error':'Please\x20message\x20@StakeSubBot\x20first\x20to\x20activate\x20this'});const B='âœ…\x20*DM\x20Alerts\x20Activated!*\x0a\x0aðŸ‘¤\x20Account:\x20*'+y['username']+'*\x0a\x0aYou\x20will\x20now\x20receive\x20code\x20drop\x20notifications\x20directly\x20in\x20this\x20chat.\x0a\x0aðŸš€\x20Happy\x20claiming!';console['log']('ðŸ“²\x20[ENABLE-ALERTS]\x20Sending\x20test\x20message\x20to\x20'+T+'\x20for\x20'+y['username']+'...');const h=await sendUserNotification(T,B,'enable_test',{'checkUserPref':![]});console['log']('ðŸ“²\x20[ENABLE-ALERTS]\x20Send\x20result:',h);if(!h['sent'])return console['log']('âŒ\x20[ENABLE-ALERTS]\x20Failed\x20to\x20send:\x20'+h['reason']),E['status'](0x190)['json']({'success':![],'error':'Please\x20message\x20@StakeSubBot\x20first\x20to\x20activate\x20this'});await firebaseDB['updateStakeAccount'](f,{'telegramNotifyEnabled':!![]}),console['log']('âœ…\x20[ENABLE-ALERTS]\x20Telegram\x20alerts\x20enabled\x20for\x20'+y['username']+'\x20('+T+')'),E['json']({'success':!![],'telegramNotifyEnabled':!![]});}catch(S){console['error']('âŒ\x20[ENABLE-ALERTS]\x20Error:',S),E['status'](0x1f4)['json']({'success':![],'error':'Internal\x20server\x20error'});}}),app['post']('/api/telegram/disable-alerts',requireAuth,async(x,E)=>{try{const f=x['user']['stakeAccountId'];await firebaseDB['updateStakeAccount'](f,{'telegramNotifyEnabled':![]}),console['log']('ðŸ“´\x20Telegram\x20alerts\x20disabled\x20for\x20account\x20'+f),E['json']({'success':!![],'telegramNotifyEnabled':![]});}catch(y){console['error']('Disable\x20telegram\x20alerts\x20error:',y),E['status'](0x1f4)['json']({'success':![],'error':'Internal\x20server\x20error'});}}),app['post']('/api/admin/notifications/test',requireAdminRole('full'),async(x,E)=>{try{const {telegramId:f,message:y}=x['body'];if(!f)return E['status'](0x190)['json']({'error':'Telegram\x20ID\x20required'});const T=y||'ðŸ””\x20*Test\x20Notification*\x0a\x0aThis\x20is\x20a\x20test\x20message\x20from\x20the\x20Stake\x20Code\x20Claimer\x20admin\x20panel.\x0a\x0aâœ…\x20Your\x20notifications\x20are\x20working!';console['log']('ðŸ“¤\x20Sending\x20test\x20notification\x20to\x20'+f+'...');const B=await sendUserNotification(f,T,'test');E['json']({'success':B['sent'],...B});}catch(h){console['error']('Test\x20notification\x20error:',h),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['get']('/api/admin/verify',(x,E)=>{const f=x['headers']['x-admin-key'],y=getAdminRole(f);if(!y)return E['status'](0x193)['json']({'error':'Invalid\x20admin\x20key'});const T={'role':y,'canAccessCodes':!![],'canAccessUsers':y==='full','canAccessSettings':y==='full','canAccessTurboMode':y==='full','canAddStakeAccounts':y==='full'};E['json'](T);}),app['post']('/api/connect',async(x,E)=>{try{const {userId:f,token:y,stakeUsername:T,authToken:B}=x['body'];if(T&&!f){const h=T['toLowerCase']()['trim'](),S=await firebaseDB['findStakeAccountsByUsername'](h),w=S['length']>0x0?S[0x0]:null;if(!w)return console['log']('âŒ\x20No\x20stake\x20account\x20found\x20for\x20username:\x20'+h),E['status'](0x194)['json']({'success':![],'error':'No\x20subscription\x20found\x20for\x20this\x20Stake\x20account.\x20Please\x20subscribe\x20first\x20via\x20Telegram.'});const o=await firebaseDB['findUserById'](w['userId']);if(!o)return E['status'](0x194)['json']({'success':![],'error':'User\x20not\x20found'});const r=await firebaseDB['findActiveSubscriptionsByUserId'](o['id']),M=r['length']>0x0,z=new Date(),N=w['trialEnd']?new Date(w['trialEnd']):null,u=N&&N>z;if(!M&&!u)return E['status'](0x193)['json']({'success':![],'error':'Subscription\x20expired.\x20Please\x20renew\x20via\x20Telegram.'});const e=jwt['sign']({'stakeAccountId':w['id'],'username':h,'userId':o['id']},process['env']['JWT_SECRET']||'stake-claimer-secret',{'expiresIn':'7d'}),l=jwt['sign']({'stakeAccountId':w['id'],'type':'refresh'},process['env']['JWT_SECRET']||'stake-claimer-secret',{'expiresIn':'30d'});let G=null;if(M&&r[0x0]['expiryAt'])G=r[0x0]['expiryAt'];else{if(w['expiryAt'])G=w['expiryAt'];else u&&w['trialEnd']&&(G=w['trialEnd']);}const Q=!!o['telegramId'],j=!!o['telegramNotifyEnabled'];return console['log']('âœ…\x20Userscript\x20connected:\x20'+h+'\x20(User\x20'+o['id']+')\x20-\x20Expires:\x20'+(G||'N/A')),E['json']({'success':!![],'accessToken':e,'refreshToken':l,'username':h,'subscriptionExpiry':G,'telegramLinked':Q,'telegramNotifyEnabled':j,'isTrial':u&&!M});}if(f&&y){const X=process['env']['CONNECT_TOKEN_SECRET']||'default-secret',m=crypto['createHmac']('sha256',X)['update'](f['toString']())['digest']('hex');if(y!==m)return E['status'](0x193)['json']({'error':'Invalid\x20token'});const I=await firebaseDB['findUserById'](parseInt(f));if(!I)return E['status'](0x194)['json']({'error':'User\x20not\x20found'});const D=await firebaseDB['findActiveSubscriptionsByUserId'](I['id']);if(D['length']===0x0)return E['status'](0x193)['json']({'error':'No\x20active\x20subscription'});return await firebaseDB['updateUser'](I['id'],{'stakeUsername':T,'status':'active'}),B&&await firebaseDB['createAuthToken']({'userId':I['id'],'tokenType':'stake_auth','tokenValue':B,'validUntil':new Date(Date['now']()+0x1e*0x18*0x3c*0x3c*0x3e8)['toISOString']()}),console['log']('âœ…\x20User\x20'+I['id']+'\x20connected\x20Stake\x20account:\x20'+T),E['json']({'success':!![],'message':'Account\x20connected\x20successfully!','username':T});}return E['status'](0x190)['json']({'error':'Missing\x20required\x20parameters'});}catch(W){console['error']('Connect\x20error:',W),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['get']('/api/subscription/status/:userId',async(x,E)=>{try{const f=parseInt(x['params']['userId']),y=await firebaseDB['findUserById'](f);if(!y)return E['status'](0x194)['json']({'error':'User\x20not\x20found'});const T=await firebaseDB['findActiveSubscriptionsByUserId'](f);E['json']({'user':y,'subscription':T[0x0]||null});}catch(B){console['error']('Status\x20error:',B),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['get']('/connect',(x,E)=>{const {userId:f,token:y}=x['query'];E['send']('\x0a<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20\x20\x20<title>Connect\x20Stake\x20Account</title>\x0a\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20*\x20{\x20margin:\x200;\x20padding:\x200;\x20box-sizing:\x20border-box;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20font-family:\x20\x27Inter\x27,\x20\x27Segoe\x20UI\x27,\x20sans-serif;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#667eea\x200%,\x20#764ba2\x20100%);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20min-height:\x20100vh;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20display:\x20flex;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20align-items:\x20center;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20justify-content:\x20center;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x2020px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20background:\x20white;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border-radius:\x2020px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x2040px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20max-width:\x20500px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20width:\x20100%;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20box-shadow:\x200\x2020px\x2060px\x20rgba(0,0,0,0.3);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20h1\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20color:\x20#667eea;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20font-size:\x2028px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20margin-bottom:\x2010px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20text-align:\x20center;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20p\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20color:\x20#666;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20line-height:\x201.6;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20margin-bottom:\x2020px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20text-align:\x20center;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.step\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20background:\x20#f5f7fa;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border-radius:\x2010px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x2015px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20margin:\x2015px\x200;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border-left:\x204px\x20solid\x20#667eea;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.step-number\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20display:\x20inline-block;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20background:\x20#667eea;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20color:\x20white;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20width:\x2030px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20height:\x2030px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border-radius:\x2050%;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20text-align:\x20center;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20line-height:\x2030px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20margin-right:\x2010px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20font-weight:\x20bold;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20button\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#667eea\x200%,\x20#764ba2\x20100%);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20color:\x20white;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border:\x20none;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x2015px\x2030px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border-radius:\x2010px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20font-size:\x2018px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20font-weight:\x20600;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cursor:\x20pointer;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20width:\x20100%;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20margin-top:\x2020px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20transition:\x20transform\x200.2s,\x20box-shadow\x200.2s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20button:hover\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20transform:\x20translateY(-2px);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20box-shadow:\x200\x2010px\x2020px\x20rgba(102,\x20126,\x20234,\x200.3);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20button:disabled\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20opacity:\x200.6;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cursor:\x20not-allowed;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.status\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20text-align:\x20center;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x2015px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border-radius:\x2010px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20margin-top:\x2020px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20display:\x20none;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.status.success\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20background:\x20#d4edda;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20color:\x20#155724;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20display:\x20block;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.status.error\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20background:\x20#f8d7da;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20color:\x20#721c24;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20display:\x20block;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.status.loading\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20background:\x20#d1ecf1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20color:\x20#0c5460;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20display:\x20block;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.loader\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20display:\x20inline-block;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20width:\x2020px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20height:\x2020px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border:\x203px\x20solid\x20rgba(0,0,0,0.1);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border-top-color:\x20#667eea;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border-radius:\x2050%;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20animation:\x20spin\x201s\x20linear\x20infinite;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20margin-right:\x2010px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20@keyframes\x20spin\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20to\x20{\x20transform:\x20rotate(360deg);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h1>ðŸ”—\x20Connect\x20Stake\x20Account</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<p>Link\x20your\x20Stake.com\x20account\x20to\x20start\x20auto-claiming\x20promo\x20codes!</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22step\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22step-number\x22>1</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Open\x20stake.com/vip-program\x20in\x20a\x20new\x20tab</strong>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22step\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22step-number\x22>2</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Make\x20sure\x20you\x27re\x20logged\x20in\x20to\x20your\x20account</strong>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22step\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22step-number\x22>3</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>Click\x20the\x20button\x20below\x20to\x20auto-connect</strong>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22connectBtn\x22\x20onclick=\x22connectAccount()\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ðŸš€\x20Connect\x20Now\x0a\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22status\x22\x20class=\x22status\x22></div>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<script>\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20userId\x20=\x20\x22'+f+'\x22;\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20token\x20=\x20\x22'+y+'\x22;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20connectAccount()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20btn\x20=\x20document.getElementById(\x27connectBtn\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20status\x20=\x20document.getElementById(\x27status\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20btn.disabled\x20=\x20true;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status.className\x20=\x20\x27status\x20loading\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status.innerHTML\x20=\x20\x27<div\x20class=\x22loader\x22></div>\x20Extracting\x20your\x20username...\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20try\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20Open\x20VIP\x20page\x20to\x20extract\x20username\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20window.open(\x27https://stake.com/vip-program\x27,\x20\x27_blank\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20Wait\x20for\x20user\x20to\x20go\x20to\x20VIP\x20page\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20await\x20new\x20Promise(resolve\x20=>\x20setTimeout(resolve,\x203000));\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status.innerHTML\x20=\x20\x27<div\x20class=\x22loader\x22></div>\x20Please\x20switch\x20to\x20the\x20Stake\x20tab\x20and\x20wait...\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20This\x20would\x20normally\x20inject\x20a\x20script\x20to\x20extract\x20username\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20For\x20now,\x20we\x27ll\x20use\x20a\x20simplified\x20approach\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20stakeUsername\x20=\x20prompt(\x27Please\x20enter\x20your\x20Stake\x20username\x20(from\x20the\x20VIP\x20page):\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!stakeUsername)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20throw\x20new\x20Error(\x27Username\x20not\x20provided\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status.innerHTML\x20=\x20\x27<div\x20class=\x22loader\x22></div>\x20Connecting\x20your\x20account...\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20Get\x20auth\x20token\x20from\x20localStorage\x20(simplified)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20authToken\x20=\x20\x27PLACEHOLDER\x27;\x20//\x20TODO:\x20Extract\x20real\x20token\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20Send\x20to\x20backend\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20response\x20=\x20await\x20fetch(\x27/api/connect\x27,\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20method:\x20\x27POST\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20headers:\x20{\x20\x27Content-Type\x27:\x20\x27application/json\x27\x20},\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body:\x20JSON.stringify({\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20token,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20stakeUsername,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20authToken\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20})\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20data\x20=\x20await\x20response.json();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(data.success)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status.className\x20=\x20\x27status\x20success\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status.innerHTML\x20=\x20\x27âœ…\x20Account\x20connected\x20successfully!\x20You\x20can\x20close\x20this\x20page\x20and\x20return\x20to\x20Telegram.\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x20else\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20throw\x20new\x20Error(data.error\x20||\x20\x27Connection\x20failed\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x20catch\x20(error)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status.className\x20=\x20\x27status\x20error\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20status.innerHTML\x20=\x20\x27âŒ\x20\x27\x20+\x20error.message;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20btn.disabled\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20</script>\x0a</body>\x0a</html>\x0a\x20\x20');}),app['get']('/api/admin/users',async(x,E)=>{try{const f=x['headers']['x-admin-key'];if(!f||f!==process['env']['ADMIN_API_KEY'])return E['status'](0x193)['json']({'error':'Unauthorized'});const y=firebaseDB['db']['ref']('stakeAccounts'),T=await y['orderByChild']('createdAt')['once']('value');if(!T['exists']())return E['json']([]);const B=[],h=[];T['forEach'](o=>{const D=o['val'](),W=parseInt(o['key']),Y=firebaseDB['findUserById'](D['userId'])['then'](V=>({'id':W,'username':D['username'],'status':D['status'],'expiryAt':D['expiryAt'],'createdAt':D['createdAt'],'telegramUserId':V?V['telegramUserId']:null,'isOnline':activeConnections['has'](W),'lastSeen':activeConnections['get'](W)?.['lastSeen']||null}));h['push'](Y);});const S=await Promise['all'](h);S['sort']((o,m)=>new Date(o['createdAt'])-new Date(m['createdAt']));const w=S['filter'](o=>o['isOnline'])['length'];E['json']({'users':S,'stats':{'total':S['length'],'online':w,'superTurbo':superTurboMode}});}catch(o){console['error']('Get\x20users\x20error:',o),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['delete']('/api/admin/users/:id',async(x,E)=>{try{const f=x['headers']['x-admin-key'];if(!f||f!==process['env']['ADMIN_API_KEY'])return E['status'](0x193)['json']({'error':'Unauthorized'});const y=parseInt(x['params']['id']),T=firebaseDB['db']['ref']('authSessions'),B=await T['orderByChild']('stakeAccountId')['equalTo'](y)['once']('value');if(B['exists']()){const h=[];B['forEach'](S=>{h['push'](T['child'](S['key'])['remove']());}),await Promise['all'](h);}await firebaseDB['db']['ref']('stakeAccounts/'+y)['remove'](),E['json']({'success':!![]});}catch(S){console['error']('Delete\x20user\x20error:',S),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['post']('/api/admin/super-turbo',async(x,E)=>{try{const f=x['headers']['x-admin-key'];if(!f||f!==process['env']['ADMIN_API_KEY'])return E['status'](0x193)['json']({'error':'Unauthorized'});const {enabled:y}=x['body'];superTurboMode=!!y,console['log']('ðŸš€\x20Super\x20Turbo\x20Mode:\x20'+(superTurboMode?'ENABLED':'DISABLED')),E['json']({'success':!![],'superTurbo':superTurboMode,'pollInterval':superTurboMode?0x32:0xc8});}catch(T){console['error']('Super\x20turbo\x20toggle\x20error:',T),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['get']('/api/codes',async(x,E)=>{try{const f=Date['now'](),y=recentCodes['filter'](T=>f-T['timestamp']<CODE_CACHE_DURATION);recentCodes['length']=0x0,recentCodes['push'](...y),E['json'](recentCodes);}catch(T){console['error']('Get\x20codes\x20error:',T),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['post']('/api/admin/codes',requireAdminRole('codes'),async(x,E)=>{try{const {code:f,value:y,limit:T,wagerRequirement:B,timeline:h}=x['body'];console['log']('\x0a==========\x20ADMIN\x20CODE\x20ADDED\x20=========='),console['log']('ðŸ‘‘\x20Code:\x20'+f),console['log']('ðŸ’°\x20Value:\x20'+(y||'N/A')),console['log']('ðŸ‘¥\x20Limit:\x20'+(T||'N/A')),console['log']('ðŸŽ²\x20Wager:\x20'+(B||'N/A')),console['log']('â°\x20Timeline:\x20'+(h||'N/A')),console['log']('ðŸ”Œ\x20Connected\x20clients:\x20'+wsClients['size']);if(!f)return console['log']('âŒ\x20Code\x20missing\x20-\x20rejected'),E['status'](0x190)['json']({'error':'Code\x20is\x20required'});const S=recentCodes['find'](o=>o['code']===f);if(S)return console['log']('âŒ\x20Code\x20already\x20exists\x20-\x20rejected'),E['status'](0x190)['json']({'error':'Code\x20already\x20exists'});const w={'code':f,'value':y||null,'limit':T||null,'wagerRequirement':B||null,'timeline':h||null,'timestamp':Date['now'](),'claimed':![],'rejectionReason':null,'source':'admin'};recentCodes['unshift'](w),codeSet['add'](f),logEvent('admin_code',{'code':f,'value':y,'limit':T,'wagerRequirement':B,'timeline':h,'connectedClients':wsClients['size']}),broadcastCode(w),sendCodeToChannel(f,y,B,T,'admin')['catch'](o=>{console['error']('âŒ\x20Failed\x20to\x20send\x20admin\x20code\x20to\x20channel:',o['message']);}),console['log']('âœ…\x20Admin\x20code\x20added\x20and\x20broadcast\x20initiated'),console['log']('=======================================\x0a'),E['json']({'success':!![],'code':w});}catch(o){console['error']('âŒ\x20Add\x20code\x20error:',o),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['delete']('/api/admin/codes/:code',requireAdminRole('codes'),async(x,E)=>{try{const f=x['params']['code'],y=recentCodes['filter'](T=>T['code']!==f);recentCodes['length']=0x0,recentCodes['push'](...y),codeSet['delete'](f),console['log']('âœ…\x20Deleted\x20code\x20from\x20cache:\x20'+f),E['json']({'success':!![]});}catch(T){console['error']('Delete\x20code\x20error:',T),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}});const CODE_PATTERN_NEW=/-\s*Code:\s*([a-z0-9]+)/i,CODE_PATTERN_STAKECOM=/\b(stakecom[a-z0-9]{6,12})\b/i,CODE_PATTERN_STANDALONE=/^(stake[a-z0-9]{10,16})$/im,VALUE_PATTERN_NEW=/-\s*Value:\s*\$?([\d,]+(?:\.\d+)?)/i,VALUE_PATTERN=/\$(\d+(?:\.\d+)?)\s+for\s+the\s+first/i,LIMIT_PATTERN_NEW=/-\s*Total\s*Drop\s*Limit:\s*\$?([\d,]+)/i,LIMIT_PATTERN=/for\s+the\s+first\s+([\d,]+)!/i,WAGER_PATTERN_NEW=/-\s*Requirements:\s*\$?([\d,]+(?:\.\d+)?)\s*wagered/i,WAGER_PATTERN=/\$([\d,]+)\s+wager\s+requirement/i,TIMELINE_PATTERN_NEW=/in\s*the\s*last\s*(\d+)\s*(day|week|hour|minute)s?/i,TIMELINE_PATTERN=/past\s+(\d+)\s+days?/i,codeSet=new Set(),TEMP_DIR='/tmp/video_ocr';!fs['existsSync'](TEMP_DIR)&&fs['mkdirSync'](TEMP_DIR,{'recursive':!![]});function fixOcrCharacters(x){return x['replace'](/O/g,'0')['replace'](/I(?=[0-9])/g,'1')['replace'](/[Bb]$/g,'5')['replace'](/[Ss]$/g,'5')['toLowerCase']();}function extractStakeCodeFromOcr(x){let E=x['replace'](/\s+/g,'')['toLowerCase']();if(E['startsWith']('takecom'))E='stakecom'+E['substring'](0x7);else E['startsWith']('tekecom')&&(E='stakecom'+E['substring'](0x7));if(E['startsWith']('cakecom'))E='stakecom'+E['substring'](0x7);else E['startsWith']('cecom')&&(E='stakecom'+E['substring'](0x5));E['startsWith']('akecom')&&(E='stakecom'+E['substring'](0x6)),E['startsWith']('sakecom')&&(E='stakecom'+E['substring'](0x7));let f=E['match'](/stakecom([a-z0-9]+)/i);if(f){let y=f[0x1];y['charAt'](0x0)==='i'&&(y='l'+y['substring'](0x1)),y=y['replace'](/O/g,'0'),y['endsWith']('b')&&(y=y['slice'](0x0,-0x1)+'5'),(y=y['replace'](/a(\d)$/,'$1'),y=y['replace'](/a(\d{2})$/,'$1'),y=y['replace'](/g(\d)$/,'q$1'),y=y['replace'](/(\d)[a-z]+$/i,'$1'));if(y['length']<0x6||y['length']>0xa)return null;return'stakecom'+y;}return null;}async function extractCodeFromThumbnail(x,E){const f=Date['now']();try{const y=E['media']?.['document'];if(!y)return null;const T=y['thumbs']||[],B=y['videoThumbnails']||[],h=y['thumb']?.['bytes']||null;console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20Checking\x20for\x20embedded\x20thumbnails...\x20('+T['length']+'\x20thumbs,\x20'+B['length']+'\x20videoThumbs,\x20jpegBytes:\x20'+(h?'YES':'NO')+')');if(h&&h['length']>0x0){const S=path['join'](TEMP_DIR,'thumb_instant_'+Date['now']()+'.jpg');fs['writeFileSync'](S,h),console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20Using\x20embedded\x20jpegBytes\x20('+h['length']+'\x20bytes)\x20-\x20INSTANT!');const w=await fastVisionExtract(S);fs['unlinkSync'](S);if(w&&w['length']>=0xe&&w['length']<=0x12)return console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20âœ…\x20INSTANT\x20CODE:\x20'+w+'\x20in\x20'+(Date['now']()-f)+'ms!'),w;}if(T['length']>0x0){const o=T['reduce']((r,M)=>{const z=(M['w']||0x0)*(M['h']||0x0),N=(r['w']||0x0)*(r['h']||0x0);return z>N?M:r;},T[0x0]);console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20Downloading\x20thumbnail\x20('+o['w']+'x'+o['h']+')...');try{const {Api:r}=require('telegram'),M=path['join'](TEMP_DIR,'thumb_'+Date['now']()+'.jpg'),z=await x['downloadMedia'](E['media'],{'thumb':o,'workers':0x4});if(z&&z['length']>0x3e8){fs['writeFileSync'](M,z),console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20Downloaded\x20in\x20'+(Date['now']()-f)+'ms\x20('+(z['length']/0x400)['toFixed'](0x0)+'KB)');const N=await fastVisionExtract(M);try{fs['unlinkSync'](M);}catch(u){}if(N&&N['length']>=0xe&&N['length']<=0x12)return console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20âœ…\x20Found\x20code:\x20'+N+'\x20in\x20'+(Date['now']()-f)+'ms!'),N;}}catch(l){console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20Thumbnail\x20download\x20failed:\x20'+l['message']);}}return console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20No\x20code\x20found\x20in\x20thumbnail\x20('+(Date['now']()-f)+'ms)'),null;}catch(G){return console['log']('ðŸ–¼ï¸\x20[THUMBNAIL]\x20Error:\x20'+G['message']),null;}}const MISTRAL_API_KEY=process['env']['MISTRAL_API_KEY'],OCR_SPACE_API_KEY=process['env']['OCR_SPACE_API_KEY'];async function mistralOCR(x){if(!MISTRAL_API_KEY)return null;const E=Date['now']();try{const f=fs['readFileSync'](x),y=f['toString']('base64'),T=path['extname'](x)['toLowerCase']()['replace']('.','')||'png',B=T==='jpg'?'image/jpeg':'image/'+T,h=await fetch('https://api.mistral.ai/v1/chat/completions',{'method':'POST','headers':{'Authorization':'Bearer\x20'+MISTRAL_API_KEY,'Content-Type':'application/json'},'body':JSON['stringify']({'model':'pixtral-12b-latest','max_tokens':0x1e,'messages':[{'role':'user','content':[{'type':'text','text':'Extract\x20the\x20stake\x20code\x20(starts\x20with\x20stakecom).\x20Reply\x20with\x20ONLY\x20the\x20code,\x20nothing\x20else.'},{'type':'image_url','image_url':{'url':'data:'+B+';base64,'+y}}]}]})}),S=await h['json'](),w=Date['now']()-E;if(S['error']||!S['choices']?.[0x0]?.['message']?.['content'])return console['log']('âš¡\x20[PIXTRAL]\x20Error\x20in\x20'+w+'ms:\x20'+(S['error']?.['message']||'No\x20response')),null;const o=S['choices'][0x0]['message']['content']['toLowerCase']()['replace'](/\s+/g,'')['trim']();console['log']('âš¡\x20[PIXTRAL]\x20Vision\x20in\x20'+w+'ms:\x20\x22'+o+'\x22');const r=o['match'](/stakecom[a-z0-9]{6,12}/);if(r)return r[0x0];const M=extractStakeCodeFromOcr(o);return M;}catch(z){return console['log']('âš¡\x20[PIXTRAL]\x20Error:\x20'+z['message']),null;}}async function ocrSpaceExtract(x){if(!OCR_SPACE_API_KEY)return null;const E=Date['now']();try{const f=fs['readFileSync'](x),y=f['toString']('base64'),T=path['extname'](x)['toLowerCase']()['replace']('.','')||'png',B=T==='jpg'?'jpeg':T,h=new URLSearchParams();h['append']('base64Image','data:image/'+B+';base64,'+y),h['append']('language','eng'),h['append']('isOverlayRequired','false'),h['append']('detectOrientation','false'),h['append']('scale','true'),h['append']('OCREngine','2');const S=await fetch('https://api.ocr.space/parse/image',{'method':'POST','headers':{'apikey':OCR_SPACE_API_KEY},'body':h}),w=await S['json'](),o=Date['now']()-E;if(w['IsErroredOnProcessing']||!w['ParsedResults']?.[0x0])return console['log']('âš¡\x20[OCR.space]\x20Error\x20in\x20'+o+'ms:\x20'+(w['ErrorMessage']||'No\x20results')),null;const r=w['ParsedResults'][0x0]['ParsedText']?.['toLowerCase']()['replace'](/\s+/g,'')||'';console['log']('âš¡\x20[OCR.space]\x20OCR\x20in\x20'+o+'ms:\x20\x22'+r['substring'](0x0,0x32)+'...\x22');const M=extractStakeCodeFromOcr(r);return M;}catch(z){return console['log']('âš¡\x20[OCR.space]\x20Error:\x20'+z['message']),null;}}async function fastVisionExtract(x){const E=Date['now'](),f=[];MISTRAL_API_KEY&&f['push'](mistralOCR(x)['then'](y=>{if(y)return console['log']('âš¡\x20[RACE]\x20Pixtral\x20won\x20in\x20'+(Date['now']()-E)+'ms!'),{'source':'mistral','code':y};throw new Error('no\x20code');})),OCR_SPACE_API_KEY&&f['push'](ocrSpaceExtract(x)['then'](y=>{if(y)return console['log']('âš¡\x20[RACE]\x20OCR.space\x20won\x20in\x20'+(Date['now']()-E)+'ms!'),{'source':'ocrspace','code':y};throw new Error('no\x20code');}));if(f['length']===0x0)return console['log']('âš¡\x20[PARALLEL\x20OCR]\x20No\x20OCR\x20APIs\x20configured!'),null;try{const y=await Promise['any'](f);return y['code'];}catch(T){return console['log']('âš¡\x20[PARALLEL\x20OCR]\x20All\x20APIs\x20failed\x20in\x20'+(Date['now']()-E)+'ms'),null;}}async function partialVideoDownload(x,E){const f=E['media']?.['document'];if(!f)return null;const y=Number(f['size'])||0x0,T=f['dcId']||0x2;if(y<0x2*0x400*0x400)return console['log']('ðŸŽ¬\x20[PARTIAL]\x20Small\x20video\x20('+(y/0x400)['toFixed'](0x0)+'KB),\x20full\x20download...'),{'buffer':await x['downloadMedia'](E['media'],{'workers':0x10,'dcId':T}),'partial':![]};const B=0xa*0x400,h=Math['max'](0x0,y-B);console['log']('ðŸŽ¬\x20[PARTIAL]\x20Video\x20'+(y/0x400/0x400)['toFixed'](0x1)+'MB\x20â†’\x20downloading\x20last\x20'+(B/0x400/0x400)['toFixed'](0x1)+'MB\x20only!');const {Api:S}=require('telegram');try{const w=Date['now'](),o=new S['InputDocumentFileLocation']({'id':f['id'],'accessHash':f['accessHash'],'fileReference':f['fileReference'],'thumbSize':''}),r=[];let M=h;const z=0x200*0x400;while(M<y){const e=Math['min'](z,y-M),l=await x['invoke'](new S['upload']['GetFile']({'location':o,'offset':BigInt(M),'limit':e,'precise':!![],'cdnSupported':![]}));r['push'](l['bytes']),M+=l['bytes']['length'];if(l['bytes']['length']<e)break;}const N=Buffer['concat'](r),u=Date['now']()-w;return console['log']('ðŸŽ¬\x20[PARTIAL]\x20Downloaded\x20TAIL\x20('+(N['length']/0x400)['toFixed'](0x0)+'KB)\x20in\x20'+u+'ms'),{'buffer':N,'partial':!![],'tailStart':h};}catch(G){return console['log']('ðŸŽ¬\x20[PARTIAL]\x20Failed:\x20'+G['message']+',\x20falling\x20back\x20to\x20full\x20download...'),{'buffer':await x['downloadMedia'](E['media'],{'workers':0x10,'dcId':T}),'partial':![]};}}async function tryExtractFrame(x,E){try{return execSync('ffmpeg\x20-y\x20-threads\x200\x20-sseof\x20-0.01\x20-i\x20\x22'+x+'\x22\x20-an\x20-sn\x20-dn\x20-vframes\x201\x20-q:v\x202\x20\x22'+E+'\x22\x202>/dev/null',{'encoding':'utf8','timeout':0x1f4}),fs['existsSync'](E)&&fs['statSync'](E)['size']>0x3e8;}catch(f){try{return execSync('ffmpeg\x20-y\x20-threads\x200\x20-i\x20\x22'+x+'\x22\x20-an\x20-sn\x20-dn\x20-vframes\x201\x20-q:v\x202\x20\x22'+E+'\x22\x202>/dev/null',{'encoding':'utf8','timeout':0x1f4}),fs['existsSync'](E)&&fs['statSync'](E)['size']>0x3e8;}catch(y){return![];}}}async function smartPartialDownload(x,E){const f=E['media']?.['document'];if(!f)return null;const y=Number(f['size'])||0x0,T=f['dcId']||0x2;if(y<0x2*0x400*0x400){console['log']('ðŸŽ¬\x20[SMART]\x20Small\x20video\x20('+(y/0x400)['toFixed'](0x0)+'KB),\x20turbo\x20download\x20with\x2032\x20workers...');const r=x['downloadMedia'](E['media'],{'workers':0x20,'dcId':T,'progressCallback':()=>{}}),M=new Promise((z,N)=>setTimeout(()=>N(new Error('Download\x20timeout')),0x1f40));try{return await Promise['race']([r,M]);}catch(z){return console['log']('ðŸŽ¬\x20[SMART]\x20Fast\x20download\x20failed:\x20'+z['message']),null;}}const {Api:B}=require('telegram'),h=new B['InputDocumentFileLocation']({'id':f['id'],'accessHash':f['accessHash'],'fileReference':f['fileReference'],'thumbSize':''}),S=0x12c*0x400,w=0x320*0x400,o=Math['max'](S,y-w);console['log']('ðŸŽ¬\x20[SMART]\x20Video\x20'+(y/0x400/0x400)['toFixed'](0x1)+'MB\x20â†’\x20HEAD\x20'+(S/0x400)['toFixed'](0x0)+'KB\x20+\x20TAIL\x20'+(w/0x400)['toFixed'](0x0)+'KB');try{const N=Date['now'](),[u,l]=await Promise['all']([((async()=>{const m=await x['invoke'](new B['upload']['GetFile']({'location':h,'offset':BigInt(0x0),'limit':S,'precise':!![],'cdnSupported':![]}));return m['bytes'];})()),((async()=>{const m=[];let F=o;while(F<y){const g=Math['min'](0x200*0x400,y-F),L=await x['invoke'](new B['upload']['GetFile']({'location':h,'offset':BigInt(F),'limit':g,'precise':!![],'cdnSupported':![]}));m['push'](L['bytes']),F+=L['bytes']['length'];if(L['bytes']['length']<g)break;}return Buffer['concat'](m);})())]),G=Date['now']()-N;console['log']('ðŸŽ¬\x20[SMART]\x20HEAD('+(u['length']/0x400)['toFixed'](0x0)+'KB)\x20+\x20TAIL('+(l['length']/0x400)['toFixed'](0x0)+'KB)\x20in\x20'+G+'ms');const Q=o-S,j=Buffer['alloc'](Math['min'](Q,0x400)),X=Buffer['concat']([u,j,l]);return console['log']('ðŸŽ¬\x20[SMART]\x20Combined:\x20'+(X['length']/0x400)['toFixed'](0x0)+'KB'),X;}catch(m){return console['log']('ðŸŽ¬\x20[SMART]\x20Partial\x20failed:\x20'+m['message']+',\x20full\x20download...'),await x['downloadMedia'](E['media'],{'workers':0x10,'dcId':T});}}async function extractCodeFromVideo(x,E){const f=Date['now'](),y=path['join'](TEMP_DIR,'video_'+f+'.mp4'),T=path['join'](TEMP_DIR,'frame_'+f+'.png'),B=path['join'](TEMP_DIR,'cropped_'+f+'.png'),h=path['join'](TEMP_DIR,'processed_'+f+'.png');try{const S=Date['now'](),w=E['media']?.['document'],o=Number(w?.['size'])||0x0;console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20SMART\x20PARTIAL\x20MODE:\x20'+(o/0x400/0x400)['toFixed'](0x1)+'MB\x20video...');const r=Date['now'](),M=await smartPartialDownload(x,E);if(!M)return console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20Download\x20failed'),null;const z=Date['now']()-r;console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20Downloaded\x20in\x20'+z+'ms\x20('+(M['length']/0x400)['toFixed'](0x0)+'KB)'),fs['writeFileSync'](y,M);const N=Date['now']();let u=0x5;try{const v=execSync('ffprobe\x20-v\x20error\x20-show_entries\x20format=duration\x20-of\x20default=noprint_wrappers=1:nokey=1\x20\x22'+y+'\x22\x202>/dev/null',{'encoding':'utf8','timeout':0x1f4})['trim']();u=parseFloat(v)||0x5;}catch(t){}const l=Math['max'](0x0,u-0.1);try{execSync('ffmpeg\x20-y\x20-ss\x20'+l['toFixed'](0x2)+'\x20-i\x20\x22'+y+'\x22\x20-vframes\x201\x20-q:v\x202\x20\x22'+T+'\x22\x202>&1',{'encoding':'utf8','timeout':0x7d0});}catch(U){console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20FFmpeg\x20attempt\x201\x20failed:\x20'+U['message']);try{execSync('ffmpeg\x20-y\x20-sseof\x20-0.1\x20-i\x20\x22'+y+'\x22\x20-vframes\x201\x20-q:v\x202\x20\x22'+T+'\x22\x202>&1',{'encoding':'utf8','timeout':0x7d0});}catch(n){console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20FFmpeg\x20attempt\x202\x20failed:\x20'+n['message']);try{const i=execSync('which\x20ffmpeg\x20||\x20echo\x20\x22NOT\x20FOUND\x22',{'encoding':'utf8'});console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20FFmpeg\x20location:\x20'+i['trim']());}catch(H){}return console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20Frame\x20extraction\x20failed'),null;}}console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20Frame\x20extracted\x20in\x20'+(Date['now']()-N)+'ms\x20(duration:\x20'+u['toFixed'](0x1)+'s)');let G=0x500,Q=0x2d0;try{const C=execSync('identify\x20-format\x20\x22%wx%h\x22\x20\x22'+T+'\x22',{'encoding':'utf8'})['trim'](),a=C['split']('x');G=parseInt(a[0x0])||0x500,Q=parseInt(a[0x1])||0x2d0,console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20Frame\x20size:\x20'+G+'x'+Q);}catch(Z){}const j=Date['now'](),X=Math['floor'](G*0.1),m=Math['floor'](Q*0.7913),I=Math['floor'](G*0.48),D=Math['floor'](Q*0.0929);if(MISTRAL_API_KEY||OCR_SPACE_API_KEY){const R=Date['now'](),O=I+'x'+D+'+'+X+'+'+m,p=B['replace']('.png','.jpg');try{execSync('convert\x20\x22'+T+'\x22\x20-crop\x20'+O+'\x20+repage\x20-resize\x20300%\x20-quality\x2095\x20\x22'+p+'\x22',{'encoding':'utf8','stdio':'pipe','timeout':0x12c}),console['log']('âš¡\x20[FAST\x20OCR]\x20Cropped+JPEG\x203x\x20to\x20'+I*0x3+'x'+D*0x3+'...');}catch(d){try{execSync('convert\x20\x22'+T+'\x22\x20-crop\x20'+O+'\x20+repage\x20\x22'+B+'\x22',{'encoding':'utf8','stdio':'pipe','timeout':0x12c}),console['log']('âš¡\x20[FAST\x20OCR]\x20Cropped\x20to\x20'+I+'x'+D+'\x20(PNG)...');}catch(K){console['log']('âš¡\x20[FAST\x20OCR]\x20Crop\x20failed,\x20using\x20full\x20frame');}}const A=[];if(fs['existsSync'](p))A['push'](p);if(fs['existsSync'](B))A['push'](B);A['push'](T);for(const c of A){const s=await fastVisionExtract(c);if(s&&s['length']>=0xe&&s['length']<=0x12){const q=Date['now']()-S,F=Date['now']()-R;return console['log']('âš¡\x20[FAST\x20OCR]\x20âœ…\x20Found:\x20'+s+'\x20in\x20'+F+'ms\x20(total:\x20'+q+'ms)'),s;}}console['log']('âš¡\x20[FAST\x20OCR]\x20No\x20code\x20found,\x20falling\x20back\x20to\x20Tesseract...');}console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20Code\x20region:\x20'+I+'x'+D+'\x20at\x20('+X+','+m+')');const W=[{'x':X,'y':m,'w':I,'h':D,'name':'exact'},{'x':X-0xa,'y':m-0x5,'w':I+0x14,'h':D+0xa,'name':'padded'}],Y='stakecom0123456789abcdefghijklmnopqrstuvwxyz',V=[{'name':'sharp','cmd':(g,L,k)=>'convert\x20\x22'+g+'\x22\x20-crop\x20'+k+'\x20+repage\x20-resize\x20600%\x20-sharpen\x200x2\x20-colorspace\x20Gray\x20-normalize\x20-threshold\x2045%\x20\x22'+L+'\x22'},{'name':'unsharp','cmd':(g,L,k)=>'convert\x20\x22'+g+'\x22\x20-crop\x20'+k+'\x20+repage\x20-resize\x20500%\x20-unsharp\x200x1+1.5+0.02\x20-colorspace\x20Gray\x20-contrast-stretch\x202%x2%\x20-threshold\x2050%\x20\x22'+L+'\x22'}];for(const g of W){const L=g['w']+'x'+g['h']+'+'+g['x']+'+'+g['y'];for(const k of V){try{execSync(k['cmd'](T,h,L),{'encoding':'utf8','stdio':'pipe'});}catch(P){continue;}try{const b=execSync('tesseract\x20\x22'+h+'\x22\x20stdout\x20-l\x20eng\x20--psm\x208\x20--oem\x201\x20'+('-c\x20tessedit_char_whitelist='+Y+'\x202>/dev/null'),{'encoding':'utf8','timeout':0x7d0})['trim']();if(b['length']>0xa){console['log']('ðŸŽ¬\x20[TESSERACT]\x20'+k['name']+':\x20\x22'+b['replace'](/\n/g,'\x20')+'\x22');const J=extractStakeCodeFromOcr(b);if(J&&J['length']>=0xe&&J['length']<=0x12){const x0=Date['now']()-S;return console['log']('ðŸŽ¬\x20[TESSERACT]\x20âœ…\x20Found:\x20'+J+'\x20in\x20'+x0+'ms'),J;}}}catch(x1){}}}return console['log']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20âŒ\x20No\x20code\x20found\x20after\x20trying\x20all\x20regions\x20('+(Date['now']()-j)+'ms)'),null;}catch(x2){return console['error']('ðŸŽ¬\x20[VIDEO\x20OCR]\x20Error:\x20'+x2['message']),null;}finally{try{fs['unlinkSync'](y);}catch(x3){}try{fs['unlinkSync'](T);}catch(x4){}try{fs['unlinkSync'](B);}catch(x5){}try{fs['unlinkSync'](h);}catch(x6){}}}function detectAndStoreCode(x){const E=Date['now']();let f=x['match'](CODE_PATTERN_NEW);!f&&(f=x['match'](CODE_PATTERN_STAKECOM)),!f&&(f=x['match'](CODE_PATTERN_STANDALONE));if(!f)return;const y=f[0x1]['toLowerCase']();if(codeSet['has'](y))return;codeSet['add'](y);const T={'code':y,'value':null,'limit':null,'wagerRequirement':null,'timeline':null,'timestamp':Date['now'](),'claimed':![],'rejectionReason':null};recentCodes['unshift'](T),broadcastCode(T);const B=Date['now']()-E;process['nextTick'](()=>{const z=x['match'](VALUE_PATTERN_NEW)||x['match'](VALUE_PATTERN),N=x['match'](LIMIT_PATTERN_NEW)||x['match'](LIMIT_PATTERN),u=x['match'](WAGER_PATTERN_NEW)||x['match'](WAGER_PATTERN),l=x['match'](TIMELINE_PATTERN_NEW)||x['match'](TIMELINE_PATTERN);T['value']=z?'$'+z[0x1]['replace'](/,/g,''):null;if(N){const Q=parseInt(N[0x1]['replace'](/,/g,'')),j=z?parseInt(z[0x1]['replace'](/,/g,'')):0x0;if(j>0x0){const X=Math['floor'](Q/j);T['limit']='First\x20'+X['toLocaleString']('en-US');}else T['limit']='First\x20'+Q['toLocaleString']('en-US');}else T['limit']=null;if(u){const a=parseInt(u[0x1]['replace'](/,/g,''));T['wagerRequirement']='$'+a['toLocaleString']('en-US')+'\x20wagered';}else T['wagerRequirement']=null;l?T['timeline']=l[0x2]?'Last\x20'+l[0x1]+'\x20'+l[0x2]+'s':l[0x1]+'\x20days':T['timeline']=null;if(T['value']||T['limit']||T['wagerRequirement']){const Z=JSON['stringify']({'type':'code_update','code':T});for(const [R,O]of wsClients){if(O['readyState']===0x1)try{O['send'](Z);}catch(p){}}console['log']('ðŸ“¡\x20Metadata\x20update\x20sent:\x20'+y+'\x20-\x20'+T['value']+',\x20'+T['limit']+',\x20'+T['wagerRequirement']);}const G=Date['now']();if(recentCodes['length']>0xa){const A=recentCodes['filter'](d=>G-d['timestamp']<CODE_CACHE_DURATION);recentCodes['length']=0x0,recentCodes['push'](...A),codeSet['clear'](),recentCodes['forEach'](d=>codeSet['add'](d['code']));}logEvent('telegram_code',{'code':y,'value':T['value'],'limit':T['limit'],'broadcastMs':B,'connectedClients':wsClients['size']});});}app['post']('/api/telegram-message',async(x,E)=>{const f=Date['now']();try{const {message:y,codes:T,value:B,timestamp:h}=x['body'];if(T&&T['length']>0x0){const S=h?f-h:0x0;console['log']('âš¡\x20[TURBO]\x20Pre-detected\x20codes\x20received\x20in\x20'+S+'ms:',T);for(const w of T){const o=w['toLowerCase']();if(!codeSet['has'](o)){codeSet['add'](o);const r={'code':o,'value':B?'$'+B:null,'limit':null,'wagerRequirement':null,'timeline':null,'timestamp':f,'claimed':![],'rejectionReason':null};recentCodes['unshift'](r),broadcastCode(r),console['log']('âš¡\x20[TURBO]\x20Broadcast\x20in\x20'+(Date['now']()-f)+'ms:\x20'+o);}}}else detectAndStoreCode(y);E['json']({'success':!![]});}catch(M){console['error']('Telegram\x20message\x20error:',M),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}}),app['post']('/api/claim-result',requireAuth,async(x,E)=>{try{const {code:f,success:y,reason:T,value:B,stakeUsername:h,source:S}=x['body'],w=x['user']['userId'],o=x['user']['stakeAccountId'];console['log']('\x0a==========\x20CLAIM\x20RESULT\x20RECEIVED\x20=========='),console['log']('ðŸ“‹\x20Code:\x20'+f),console['log']((y?'âœ…':'âŒ')+'\x20Result:\x20'+(y?'SUCCESS':'REJECTED'));if(!y&&T)console['log']('ðŸ“\x20Reason:\x20'+T);console['log']('ðŸ”—\x20Source:\x20'+(S||'auto'));if(!f)return E['status'](0x190)['json']({'error':'Code\x20is\x20required'});const r=await firebaseDB['getStakeAccountWithUser'](o),M=r?.['user']?.['telegramUserId'],z=h||r?.['username']||'Account#'+o;console['log']('ðŸ‘¤\x20Username:\x20'+z),console['log']('ðŸ“±\x20Telegram\x20ID:\x20'+(M||'NOT\x20LINKED'));const N=y?'claim_success':'claim_rejected';logEvent(N,{'code':f,'username':z,'telegramId':M,'value':B||null,'reason':T||null,'source':S||'auto'});let u=![];const e=r?.['telegramNotifyEnabled']===!![];console['log']('ðŸ””\x20User\x20DM\x20alerts:\x20'+(e?'ON':'OFF'));if(notificationSettings['telegramEnabled']&&M){if(e){const l=D=>{if(!D)return D;return String(D)['replace'](/[_*[\]()~`>#+=|{}.!-]/g,'\x5c$&');},G=l(f),Q=l(z),j=l(T||'Unknown'),X=l(B),m=y?'âœ…\x20CODE\x20CLAIMED\x5c!\x0a\x0a'+('Code:\x20`'+f+'`\x0a')+(B?'ðŸ’°\x20Value:\x20'+X+'\x0a':'')+('ðŸ‘¤\x20Account:\x20'+Q+'\x0a\x0a')+'ðŸŽ‰\x20Successfully\x20added\x20to\x20your\x20balance\x5c!':'âŒ\x20CODE\x20REJECTED\x0a\x0a'+('Code:\x20`'+f+'`\x0a')+('ðŸ‘¤\x20Account:\x20'+Q+'\x0a')+('ðŸ“\x20Reason:\x20'+j+'\x0a\x0a')+'ðŸ’¡\x20This\x20code\x20may\x20be\x20expired\x20or\x20already\x20claimed\x5c.';console['log']('ðŸ“¤\x20Sending\x20claim\x20DM\x20to\x20'+M+'...');const I=await sendUserNotification(M,m,'claim_result',{'checkUserPref':![]});u=I['sent'],u?console['log']('âœ…\x20Claim\x20DM\x20SENT\x20to\x20'+M):console['error']('âŒ\x20Claim\x20DM\x20FAILED\x20to\x20'+M+':\x20'+I['reason']);}else console['log']('ðŸ“´\x20Claim\x20DM\x20skipped\x20for\x20'+z+'\x20(DM\x20alerts\x20OFF)');if(notificationSettings['adminChatId']){const D='ðŸ“‹\x20*CLAIM\x20'+(y?'SUCCESS':'REJECTED')+'*\x0a\x0a'+('*Code:*\x20`'+f+'`\x0a')+('ðŸ‘¤\x20*User:*\x20'+z+'\x0a')+('ðŸ“±\x20*Telegram:*\x20'+(M||'Not\x20linked')+'\x0a')+('ðŸ””\x20*DM\x20Alerts:*\x20'+(e?'ON':'OFF')+'\x0a')+(y?B?'ðŸ’°\x20*Value:*\x20'+B+'\x0a':'':'ðŸ“\x20*Reason:*\x20'+(T||'Unknown')+'\x0a')+('ðŸ”—\x20*Source:*\x20'+(S||'auto'));await sendAdminNotification(D,'claim_result');}}else!M&&(logEvent('notification_failed',{'type':'claim_result','username':z,'reason':'No\x20Telegram\x20ID\x20linked'}),console['log']('âš ï¸\x20Cannot\x20send\x20DM\x20-\x20no\x20Telegram\x20ID\x20linked\x20for\x20'+z));console['log']('============================================\x0a'),broadcastAdminUpdate({'type':'claim_result','accountId':o,'username':z,'code':f,'success':y,'reason':T||null,'value':B||null,'timestamp':Date['now']()}),E['json']({'success':!![],'notified':u,'telegramId':M||null});}catch(W){console['error']('âŒ\x20Claim\x20result\x20error:',W),E['status'](0x1f4)['json']({'error':'Internal\x20server\x20error'});}});function broadcastAdminUpdate(x){if(adminClients['size']===0x0)return;const E=JSON['stringify'](x);for(const f of adminClients){if(f['readyState']===0x1)try{f['send'](E);}catch(y){adminClients['delete'](f);}else adminClients['delete'](f);}}const server=app['listen'](PORT,'0.0.0.0',async()=>{console['log']('ðŸš€\x20API\x20server\x20running\x20on\x20port\x20'+PORT),console['log']('ðŸ“¡\x20Webhook\x20URL:\x20http://0.0.0.0:'+PORT+'/api/oxapay/webhook'),console['log']('ðŸ“Š\x20Admin\x20Dashboard:\x20http://0.0.0.0:'+PORT+'/admin.html'),console['log']('\x0a============\x20TELEGRAM\x20BOT\x20VALIDATION\x20============'),telegramBotValid=await validateBotToken(),console['log']('==================================================\x0a'),wss=new WebSocketServer({'server':server,'path':'/ws','perMessageDeflate':![],'maxPayload':0x40*0x400}),server['on']('connection',x=>{x['setNoDelay'](!![]);}),console['log']('ðŸ”Œ\x20WebSocket\x20server\x20ready\x20at\x20ws://0.0.0.0:'+PORT+'/ws\x20(TURBO\x20MODE)'),console['log']('\x20\x20\x20âš¡\x20Compression:\x20DISABLED\x20|\x20TCP_NODELAY:\x20ENABLED'),wss['on']('connection',(x,E)=>{let f=null,y=null,T=![];x['isAlive']=!![],x['on']('pong',()=>{x['isAlive']=!![];}),x['on']('message',async r=>{try{const M=JSON['parse'](r['toString']());if(M['type']==='auth'&&M['token'])try{const z=jwt['verify'](M['token'],JWT_SECRET);f=z['stakeAccountId'],T=!![],x['accountId']=f,wsClients['set'](f,x),y=await firebaseDB['getStakeAccountWithUser'](f),x['accountInfo']=y,x['send'](JSON['stringify']({'type':'auth_success','turboMode':superTurboMode,'recentCodes':recentCodes}));const N=y?.['username']||'Account#'+f,u=y?.['user']?.['telegramUserId'];logEvent('connect',{'username':N,'accountId':f,'telegramId':u,'totalOnline':wsClients['size']}),activeConnections['set'](f,{'username':N,'lastSeen':Date['now']()}),broadcastAdminUpdate({'type':'user_connected','accountId':f,'username':N,'totalOnline':wsClients['size']});if(notificationSettings['telegramEnabled']&&u){const Y=y?.['telegramNotifyEnabled']===!![];if(Y){const V='ðŸŸ¢\x20*CONNECTED*\x0a\x0a'+('Your\x20account\x20*'+N+'*\x20is\x20now\x20online\x20and\x20ready\x20to\x20auto-claim\x20codes!\x0a\x0a')+'ðŸ“¡\x20WebSocket\x20connected\x0a'+'âš¡\x20Instant\x20code\x20delivery\x20active';sendUserNotification(u,V,'connect',{'checkUserPref':![]}),console['log']('ðŸ“²\x20Connection\x20alert\x20sent\x20to\x20'+N+'\x20(DM\x20alerts\x20ON)');}else console['log']('ðŸ“´\x20Connection\x20alert\x20skipped\x20for\x20'+N+'\x20(DM\x20alerts\x20OFF)');if(notificationSettings['adminChatId']){const v='ðŸŸ¢\x20*USER\x20CONNECTED*\x0a\x0a'+('ðŸ‘¤\x20*User:*\x20'+N+'\x0a')+('ðŸ“±\x20*Telegram:*\x20'+(u||'Not\x20linked')+'\x0a')+('ðŸ””\x20*DM\x20Alerts:*\x20'+(Y?'ON':'OFF')+'\x0a')+('ðŸ‘¥\x20*Total\x20Online:*\x20'+wsClients['size']);sendAdminNotification(v,'connect');}}}catch(t){x['send'](JSON['stringify']({'type':'auth_error','message':'Invalid\x20token'})),x['close']();}M['type']==='ping'&&(x['send'](JSON['stringify']({'type':'pong'})),f&&M['username']&&activeConnections['set'](f,{'username':M['username'],'lastSeen':Date['now']()})),M['type']==='admin_subscribe'&&(M['adminKey']&&M['adminKey']===process['env']['ADMIN_API_KEY']?(x['isAdmin']=!![],adminClients['add'](x),x['send'](JSON['stringify']({'type':'admin_auth_success','totalOnline':wsClients['size']})),console['log']('ðŸ‘‘\x20Admin\x20subscribed\x20to\x20real-time\x20updates\x20('+adminClients['size']+'\x20admin(s))')):(x['send'](JSON['stringify']({'type':'admin_auth_error','message':'Invalid\x20admin\x20key'})),console['log']('â›”\x20Admin\x20subscription\x20rejected:\x20invalid\x20key')));}catch(U){}}),x['on']('close',async()=>{x['isAdmin']&&(adminClients['delete'](x),console['log']('ðŸ‘‘\x20Admin\x20disconnected\x20('+adminClients['size']+'\x20admin(s)\x20remaining)'));if(f){wsClients['delete'](f),activeConnections['delete'](f);const e=y?.['username']||'Account#'+f,l=y?.['user']?.['telegramUserId'];logEvent('disconnect',{'username':e,'accountId':f,'telegramId':l,'totalOnline':wsClients['size']}),broadcastAdminUpdate({'type':'user_disconnected','accountId':f,'username':e,'totalOnline':wsClients['size']});if(notificationSettings['telegramEnabled']&&l){const G=y?.['telegramNotifyEnabled']===!![];if(G){const Q='ðŸ”´\x20*DISCONNECTED*\x0a\x0a'+('Your\x20account\x20*'+e+'*\x20went\x20offline.\x0a\x0a')+'âš ï¸\x20Codes\x20will\x20NOT\x20be\x20auto-claimed\x20while\x20offline.\x0a'+'ðŸ’¡\x20Refresh\x20Stake.com\x20to\x20reconnect.';sendUserNotification(l,Q,'disconnect',{'checkUserPref':![]}),console['log']('ðŸ“²\x20Disconnect\x20alert\x20sent\x20to\x20'+e+'\x20(DM\x20alerts\x20ON)');}else console['log']('ðŸ“´\x20Disconnect\x20alert\x20skipped\x20for\x20'+e+'\x20(DM\x20alerts\x20OFF)');if(notificationSettings['adminChatId']){const j='ðŸ”´\x20*USER\x20DISCONNECTED*\x0a\x0a'+('ðŸ‘¤\x20*User:*\x20'+e+'\x0a')+('ðŸ“±\x20*Telegram:*\x20'+(l||'Not\x20linked')+'\x0a')+('ðŸ””\x20*DM\x20Alerts:*\x20'+(G?'ON':'OFF')+'\x0a')+('ðŸ‘¥\x20*Total\x20Online:*\x20'+wsClients['size']);sendAdminNotification(j,'disconnect');}}}}),x['on']('error',M=>{console['error']('WS\x20error:',M['message']);});}),setInterval(()=>{if(!wss)return;wss['clients']['forEach'](x=>{if(!x['isAlive'])return x['terminate']();x['isAlive']=![],x['ping']();});},0x2710),require['main']===module&&setTimeout(async()=>{try{await startBots();}catch(x){console['error']('ðŸ’¥\x20Bot\x20startup\x20error:',x),console['error'](x['stack']);}},0x32);});async function startBots(){console['log']('\x0a'+'='['repeat'](0x3c)),console['log']('ðŸ¤–\x20Starting\x20integrated\x20bots...'),console['log']('='['repeat'](0x3c)+'\x0a');const x=[];console['log']('ðŸ“\x20Checking\x20SUBSCRIPTION_BOT_TOKEN...');try{if(process['env']['SUBSCRIPTION_BOT_TOKEN']){console['log']('\x20\x20\x20âœ“\x20SUBSCRIPTION_BOT_TOKEN\x20found,\x20loading\x20bot...');const {bot:E}=require('../subscription-bot-v2.js');console['log']('\x20\x20\x20âœ“\x20Bot\x20module\x20loaded');const f=process['env']['REPLIT_DEV_DOMAIN']?'https://'+process['env']['REPLIT_DEV_DOMAIN']:process['env']['DOMAIN']||'http://localhost:5000',y='/webhook',T=''+f+y;try{await E['telegram']['setWebhook'](T),console['log']('\x20\x20\x20âœ“\x20Webhook\x20set:\x20'+T),global['subscriptionBot']=E,console['log']('âœ…\x20Subscription\x20bot\x20ready\x20(webhook\x20mode)');}catch(B){console['error']('âŒ\x20Failed\x20to\x20set\x20webhook:',B['message']),console['log']('\x20\x20\x20â©\x20Trying\x20long\x20polling\x20fallback...'),E['launch']()['then'](()=>{console['log']('âœ…\x20Subscription\x20bot\x20started\x20(polling\x20mode)');})['catch'](h=>{console['error']('âŒ\x20Subscription\x20bot\x20launch\x20error:',h['message']);});}process['once']('SIGINT',()=>E['stop']('SIGINT')),process['once']('SIGTERM',()=>E['stop']('SIGTERM'));}else console['warn']('âš ï¸\x20\x20SUBSCRIPTION_BOT_TOKEN\x20not\x20set\x20-\x20subscription\x20bot\x20skipped'),x['push']('SUBSCRIPTION_BOT_TOKEN\x20missing');}catch(h){console['error']('âŒ\x20Failed\x20to\x20start\x20subscription\x20bot:',h['message']),console['error'](h['stack']),x['push']('Subscription\x20bot:\x20'+h['message']);}console['log']('\x0aðŸ“\x20Checking\x20TELEGRAM_API_ID\x20and\x20TELEGRAM_API_HASH...');try{if(process['env']['TELEGRAM_API_ID']&&process['env']['TELEGRAM_API_HASH']){console['log']('\x20\x20\x20âœ“\x20Telegram\x20credentials\x20found');const {TelegramClient:S}=require('telegram'),{StringSession:w}=require('telegram/sessions'),{NewMessage:o}=require('telegram/events'),r=parseInt(process['env']['TELEGRAM_API_ID']),M=process['env']['TELEGRAM_API_HASH'];let z=process['env']['TELEGRAM_SESSION']||process['env']['TELEGRAM_SESSION_STRING']||'';console['log']('\x20\x20\x20Session\x20length:\x20'+z['length']+'\x20characters');if(z&&z['length']>0x0){const N=/^[A-Za-z0-9+/=]+$/['test'](z)&&z['length']>0x64;!N&&(console['log']('âš ï¸\x20\x20Invalid\x20session\x20string\x20detected,\x20telegram\x20client\x20skipped'),z='');}if(!z||z['length']<0x64)console['warn']('âš ï¸\x20\x20No\x20valid\x20TELEGRAM_SESSION\x20found\x20-\x20telegram\x20client\x20skipped'),console['warn']('\x20\x20\x20Generate\x20session\x20with:\x20node\x20login.js'),x['push']('TELEGRAM_SESSION\x20missing/invalid');else{console['log']('\x20\x20\x20âœ“\x20Valid\x20session\x20detected,\x20connecting...');const u=['StakecomDailyDrops','staketestmessages','stakecomhighrollers'],e='@stakecodedropsgoofy';console['log']('ðŸ“±\x20Starting\x20Telegram\x20User\x20Client\x20(TURBO\x20MODE)...');const l=new w(z),G=new S(l,r,M,{'connectionRetries':0xa,'retryDelay':0xa,'autoReconnect':!![],'useWSS':!![],'requestRetries':0x2,'floodSleepThreshold':0x0,'timeout':0x2710,'deviceModel':'StakeCodeBot','systemVersion':'ULTRASPEED','appVersion':'7.7.0','langCode':'en','systemLangCode':'en'});await G['connect'](),console['log']('âœ…\x20Telegram\x20client\x20connected');const Q=await G['getEntity'](e);gramjsClient=G,gramjsTargetChannel=Q,console['log']('\x20\x20\x20âœ“\x20GramJS\x20client\x20stored\x20globally\x20for\x20admin\x20codes');const j=[],X=new Map();for(const W of u){try{const Y=await G['getEntity'](W);j['push'](Y),X['set'](Y['id']['toString'](),W),console['log']('\x20\x20\x20âœ“\x20'+(Y['title']||W)+'\x20â†’\x20'+W);}catch(V){console['error']('\x20\x20\x20âœ—\x20'+W);}}if(j['length']===0x0)throw new Error('No\x20source\x20groups\x20accessible');console['log']('âœ…\x20Monitoring\x20'+j['length']+'\x20groups\x20â†’\x20'+e);const m=new Set(j['map'](v=>v['id']['toString']()));console['log']('\x20\x20\x20âš¡\x20Fast\x20lookup\x20enabled\x20for\x20'+m['size']+'\x20groups');function I(v){if(!v)return null;const x5=parseInt(String(v)['replace'](/,/g,''));if(isNaN(x5))return v;return x5['toLocaleString']('en-US');}async function D(v,xN,xu,xe,xl,xG){let xQ;switch(xN){case'StakecomDailyDrops':xQ='ðŸŽ\x20Daily\x20Code\x20-\x20Goofy\x20ðŸŽ';break;case'stakecomhighrollers':xQ='ðŸŽ\x20Highroller\x20Code\x20-\x20Goofy\x20ðŸŽ';break;case'staketestmessages':xQ='ðŸŽ\x20Test\x20Code\x20-\x20Goofy\x20ðŸŽ';break;default:xQ='ðŸŽ\x20Code\x20Drop\x20-\x20Goofy\x20ðŸŽ';}const xj=xe?'$'+I(xe):'$?',xX=xl?'$'+I(xl):'$?';let xm='?';if(xG&&xe){const xV=parseInt(String(xG)['replace'](/,/g,'')),xv=parseInt(String(xe)['replace'](/,/g,''));if(!isNaN(xV)&&!isNaN(xv)&&xv>0x0){const xt=Math['floor'](xV/xv);xm=I(xt);}}const xI='https://playstake.club/drop?code='+xu,xD=xQ+'\x0a\x0aCÎ¿ÔÐµ:\x20'+xj+'\x20-\x20'+xu+'\x0aRequirement:\x20'+xX+'\x20last\x207\x20days\x0aClaim\x20limit:\x20'+xm+'\x20users\x0aAutomic\x20Claim\x20Bot\x20:\x20@StakeSubBot\x0aClaim\x20link:\x20Click\x20here',xW='Click\x20here',xY=xD['length']-xW['length'];try{const {Api:xU}=require('telegram');await G['sendMessage'](v,{'message':xD,'formattingEntities':[new xU['MessageEntityTextUrl']({'offset':xY,'length':xW['length'],'url':xI})],'linkPreview':![]}),console['log']('ðŸ“¤\x20Sent\x20formatted\x20'+xN+'\x20message\x20for\x20code\x20'+xu);}catch(xn){console['error']('âŒ\x20Failed\x20to\x20send\x20formatted\x20message:\x20'+xn['message']);try{await G['sendMessage'](v,{'message':xD+('\x0a'+xI),'linkPreview':![]});}catch(xi){}}}G['addEventHandler'](async v=>{const xl=Date['now']();try{const xG=v['message'];if(!xG)return;const xQ=xG['peerId']?.['channelId']?.['toString']()||xG['peerId']?.['chatId']?.['toString']()||xG['chatId']?.['toString']();if(!xQ||!m['has'](xQ)){const xi=await xG['getChat']();if(!xi||!m['has'](xi['id']?.['toString']()))return;}const xj=X['get'](xQ)||'unknown',xX=xG['message']||'',xm=xG['media']&&(xG['media']['className']==='MessageMediaDocument'&&xG['media']['document']?.['mimeType']?.['startsWith']('video/'))||xG['media']?.['className']==='MessageMediaVideo';if(xm){const xH=xX['match'](/-\s*Code:\s*([a-z0-9]+)/i)||xX['match'](/\b(stakecom[a-z0-9]{6,12})\b/i),xC={'value':xX['match'](/-\s*Value:\s*\$?([\d,]+(?:\.\d+)?)/i)?.[0x1]?.['replace'](/,/g,''),'limit':xX['match'](/-\s*Total\s*Drop\s*Limit:\s*\$?([\d,]+)/i)?.[0x1]?.['replace'](/,/g,''),'wager':xX['match'](/-\s*Requirements:\s*\$?([\d,]+(?:\.\d+)?)\s*wagered/i)?.[0x1]?.['replace'](/,/g,'')};if(xH){const xa=xH[0x1]['toLowerCase']();console['log']('âš¡\x20Video\x20has\x20code\x20in\x20text:\x20'+xa+'\x20-\x20SKIPPING\x20video\x20OCR!');let xZ='-\x20Code:\x20'+xa;if(xC['value'])xZ+='\x0a-\x20Value:\x20$'+xC['value'];if(xC['limit'])xZ+='\x0a-\x20Total\x20Drop\x20Limit:\x20'+xC['limit'];if(xC['wager'])xZ+='\x0a-\x20Requirements:\x20$'+xC['wager']+'\x20wagered';detectAndStoreCode(xZ),D(Q,xj,xa,xC['value'],xC['wager'],xC['limit']);}else{console['log']('ðŸŽ¬\x20Video\x20message\x20-\x20trying\x20THUMBNAIL\x20first...');const xR=(xO,xp)=>{console['log']('ðŸŽ¬\x20'+xp+'\x20found\x20code:\x20'+xO);let xA='-\x20Code:\x20'+xO;if(xC['value'])xA+='\x0a-\x20Value:\x20$'+xC['value'];if(xC['limit'])xA+='\x0a-\x20Total\x20Drop\x20Limit:\x20'+xC['limit'];if(xC['wager'])xA+='\x0a-\x20Requirements:\x20$'+xC['wager']+'\x20wagered';detectAndStoreCode(xA),D(Q,xj,xO,xC['value'],xC['wager'],xC['limit']);};extractCodeFromThumbnail(G,xG)['then'](xO=>{xO?xR(xO,'ðŸ–¼ï¸\x20THUMBNAIL\x20OCR\x20(instant)'):(console['log']('ðŸŽ¬\x20Thumbnail\x20failed\x20-\x20downloading\x20video...'),console['log']('ðŸŽ¬\x20Video\x20metadata:',xC),extractCodeFromVideo(G,xG)['then'](xp=>{xp?xR(xp,'ðŸŽ¬\x20Video\x20LAST\x20FRAME\x20OCR'):console['log']('ðŸŽ¬\x20Video\x20OCR\x20failed\x20-\x20no\x20code\x20found');})['catch'](xp=>{console['error']('ðŸŽ¬\x20Video\x20OCR\x20error:\x20'+xp['message']);}));})['catch'](xO=>{console['error']('ðŸ–¼ï¸\x20Thumbnail\x20OCR\x20error:\x20'+xO['message']),extractCodeFromVideo(G,xG)['then'](xp=>{xp&&xR(xp,'ðŸŽ¬\x20Video\x20LAST\x20FRAME\x20OCR');})['catch'](()=>{});});}}else detectAndStoreCode(xX);const xI=Date['now']()-xl;console['log']('ðŸ“©\x20Code\x20detected\x20in\x20'+xI+'ms\x20â†’\x20broadcasting\x20to\x20'+wsClients['size']+'\x20clients');const xD=xX['match'](/-\s*Code:\s*([a-z0-9]+)/i)||xX['match'](/\b(stakecom[a-z0-9]{6,12})\b/i),xW=xX['match'](/-\s*Value:\s*\$?([\d,.]+)/i)||xX['match'](/\$\s*([\d,.]+)/i),xY=xX['match'](/-\s*Requirements:\s*\$?([\d,]+)/i)||xX['match'](/\$\s*([\d,]+)\s*wagered/i),xV=xX['match'](/-\s*Total\s*Drop\s*Limit:\s*\$?([\d,]+)/i)||xX['match'](/first\s+([\d,]+)\s*(?:users?|people)/i),xv=xD?xD[0x1]:null,xt=xW?xW[0x1]['replace'](/,/g,''):null,xU=xY?xY[0x1]['replace'](/,/g,''):null,xn=xV?xV[0x1]['replace'](/,/g,''):null;!xm&&xv&&process['nextTick'](async()=>{await D(Q,xj,xv,xt,xU,xn);});}catch(xO){if(process['env']['DEBUG'])console['error']('Message\x20handler\x20error:',xO['message']);}},new o({}));}}else console['warn']('âš ï¸\x20\x20TELEGRAM_API_ID/HASH\x20not\x20set\x20-\x20telegram\x20client\x20skipped'),x['push']('TELEGRAM_API_ID/HASH\x20missing');}catch(v){console['error']('âŒ\x20Failed\x20to\x20start\x20telegram\x20client:',v['message']),x['push']('Telegram\x20client:\x20'+v['message']);}console['log']('\x0a'+'='['repeat'](0x3c)),x['length']===0x0?console['log']('âœ…\x20All\x20bots\x20running'):console['log']('âš ï¸\x20\x20Some\x20bots\x20skipped:',x['join'](',\x20')),console['log']('='['repeat'](0x3c)+'\x0a');}module['exports']=app;
